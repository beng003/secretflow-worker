# é¢„å¤„ç†ä»»åŠ¡æ¨¡å—é‡æ„æ€»ç»“

## é‡æ„æ¦‚è¿°

**å®Œæˆæ—¥æœŸ**: 2026-01-05  
**ç›®æ ‡**: é‡æ„é¢„å¤„ç†ä»»åŠ¡æ¨¡å—ï¼Œå‚è€ƒSecretFlowçš„preprocessingå’Œstatsæ¨¡å—ï¼Œåˆ›å»ºæ›´æ¸…æ™°çš„ç›®å½•ç»“æ„

## é‡æ„åŠ¨æœº

### åŸæœ‰é—®é¢˜

1. **å•æ–‡ä»¶è¿‡å¤§**: æ‰€æœ‰é¢„å¤„ç†ä»»åŠ¡é›†ä¸­åœ¨`preprocessing_task.py`ä¸­
2. **ç¼ºä¹ç»„ç»‡**: ä¸åŒç±»å‹çš„é¢„å¤„ç†ä»»åŠ¡æ··åœ¨ä¸€èµ·
3. **éš¾ä»¥æ‰©å±•**: æ·»åŠ æ–°ä»»åŠ¡éœ€è¦ä¿®æ”¹å¤§æ–‡ä»¶
4. **ä¸ç¬¦åˆSecretFlowé£æ ¼**: ä¸SecretFlowçš„æ¨¡å—ç»„ç»‡æ–¹å¼ä¸ä¸€è‡´

### è§£å†³æ–¹æ¡ˆ

å‚è€ƒSecretFlowçš„`preprocessing`æ¨¡å—ç»“æ„ï¼ŒæŒ‰åŠŸèƒ½åˆ†ç±»åˆ›å»ºå­æ¨¡å—ï¼š
- **scaler**: æ•°æ®æ ‡å‡†åŒ–å’Œå½’ä¸€åŒ–
- **encoder**: æ ‡ç­¾ç¼–ç å’Œç‹¬çƒ­ç¼–ç 
- **binning**: æ•°æ®åˆ†ç®±
- **fillna**: ç¼ºå¤±å€¼å¡«å……

## æ–°çš„ç›®å½•ç»“æ„

```
src/secretflow_task/jobs/preprocessing/
â”œâ”€â”€ __init__.py                          # æ¨¡å—å¯¼å‡º
â”œâ”€â”€ scaler/                              # æ•°æ®ç¼©æ”¾å­æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ standard_scaler_task.py          # æ ‡å‡†åŒ–
â”‚   â””â”€â”€ minmax_scaler_task.py            # å½’ä¸€åŒ–
â”œâ”€â”€ encoder/                             # æ•°æ®ç¼–ç å­æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ label_encoder_task.py            # æ ‡ç­¾ç¼–ç 
â”‚   â””â”€â”€ onehot_encoder_task.py           # ç‹¬çƒ­ç¼–ç 
â”œâ”€â”€ binning/                             # æ•°æ®åˆ†ç®±å­æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ quantile_binning_task.py         # ç­‰é¢‘åˆ†ç®±
â”‚   â””â”€â”€ equal_width_binning_task.py      # ç­‰å®½åˆ†ç®±
â””â”€â”€ fillna/                              # ç¼ºå¤±å€¼å¡«å……å­æ¨¡å—
    â”œâ”€â”€ __init__.py
    â””â”€â”€ fillna_task.py                   # ç¼ºå¤±å€¼å¡«å……
```

## å®ç°çš„ä»»åŠ¡

### 1. Scalerå­æ¨¡å—

#### StandardScalerï¼ˆæ ‡å‡†åŒ–ï¼‰
- **æ–‡ä»¶**: `scaler/standard_scaler_task.py`
- **ä»»åŠ¡ç±»å‹**: `standard_scaler`
- **åŠŸèƒ½**: å°†æ•°æ®æ ‡å‡†åŒ–ä¸ºå‡å€¼0ã€æ ‡å‡†å·®1
- **å‚æ•°**:
  - `input_data`: è¾“å…¥æ•°æ®è·¯å¾„å­—å…¸
  - `output_data`: è¾“å‡ºæ•°æ®è·¯å¾„å­—å…¸
  - `columns`: éœ€è¦æ ‡å‡†åŒ–çš„åˆ—ååˆ—è¡¨
  - `with_mean`: æ˜¯å¦å‡å»å‡å€¼
  - `with_std`: æ˜¯å¦é™¤ä»¥æ ‡å‡†å·®

#### MinMaxScalerï¼ˆå½’ä¸€åŒ–ï¼‰
- **æ–‡ä»¶**: `scaler/minmax_scaler_task.py`
- **ä»»åŠ¡ç±»å‹**: `minmax_scaler`
- **åŠŸèƒ½**: å°†æ•°æ®ç¼©æ”¾åˆ°æŒ‡å®šèŒƒå›´ï¼ˆé»˜è®¤[0, 1]ï¼‰
- **å‚æ•°**:
  - `input_data`: è¾“å…¥æ•°æ®è·¯å¾„å­—å…¸
  - `output_data`: è¾“å‡ºæ•°æ®è·¯å¾„å­—å…¸
  - `columns`: éœ€è¦å½’ä¸€åŒ–çš„åˆ—ååˆ—è¡¨
  - `feature_range`: ç›®æ ‡èŒƒå›´ï¼Œé»˜è®¤(0, 1)

### 2. Encoderå­æ¨¡å—

#### LabelEncoderï¼ˆæ ‡ç­¾ç¼–ç ï¼‰
- **æ–‡ä»¶**: `encoder/label_encoder_task.py`
- **ä»»åŠ¡ç±»å‹**: `label_encoder`
- **åŠŸèƒ½**: å°†ç±»åˆ«å‹ç‰¹å¾è½¬æ¢ä¸ºæ•°å€¼æ ‡ç­¾ï¼ˆ0, 1, 2, ...ï¼‰
- **å‚æ•°**:
  - `input_data`: è¾“å…¥æ•°æ®è·¯å¾„å­—å…¸
  - `output_data`: è¾“å‡ºæ•°æ®è·¯å¾„å­—å…¸
  - `columns`: éœ€è¦ç¼–ç çš„åˆ—ååˆ—è¡¨

#### OneHotEncoderï¼ˆç‹¬çƒ­ç¼–ç ï¼‰
- **æ–‡ä»¶**: `encoder/onehot_encoder_task.py`
- **ä»»åŠ¡ç±»å‹**: `onehot_encoder`
- **åŠŸèƒ½**: å°†ç±»åˆ«å‹ç‰¹å¾è½¬æ¢ä¸ºç‹¬çƒ­ç¼–ç ï¼ˆäºŒè¿›åˆ¶å‘é‡ï¼‰
- **å‚æ•°**:
  - `input_data`: è¾“å…¥æ•°æ®è·¯å¾„å­—å…¸
  - `output_data`: è¾“å‡ºæ•°æ®è·¯å¾„å­—å…¸
  - `columns`: éœ€è¦ç¼–ç çš„åˆ—ååˆ—è¡¨
  - `drop`: æ˜¯å¦åˆ é™¤ç¬¬ä¸€åˆ—ï¼ˆ'first'/'if_binary'/Noneï¼‰

### 3. Binningå­æ¨¡å—

#### QuantileBinningï¼ˆç­‰é¢‘åˆ†ç®±ï¼‰
- **æ–‡ä»¶**: `binning/quantile_binning_task.py`
- **ä»»åŠ¡ç±»å‹**: `quantile_binning`
- **åŠŸèƒ½**: æŒ‰åˆ†ä½æ•°è¿›è¡Œåˆ†ç®±ï¼Œæ¯ä¸ªç®±æ ·æœ¬æ•°é‡å¤§è‡´ç›¸ç­‰
- **å‚æ•°**:
  - `input_data`: è¾“å…¥æ•°æ®è·¯å¾„å­—å…¸
  - `output_data`: è¾“å‡ºæ•°æ®è·¯å¾„å­—å…¸
  - `columns`: éœ€è¦åˆ†ç®±çš„åˆ—ååˆ—è¡¨
  - `n_bins`: åˆ†ç®±æ•°é‡ï¼Œé»˜è®¤5

#### EqualWidthBinningï¼ˆç­‰å®½åˆ†ç®±ï¼‰
- **æ–‡ä»¶**: `binning/equal_width_binning_task.py`
- **ä»»åŠ¡ç±»å‹**: `equal_width_binning`
- **åŠŸèƒ½**: æŒ‰ç­‰å®½åŒºé—´è¿›è¡Œåˆ†ç®±ï¼Œæ¯ä¸ªç®±å®½åº¦ç›¸ç­‰
- **å‚æ•°**:
  - `input_data`: è¾“å…¥æ•°æ®è·¯å¾„å­—å…¸
  - `output_data`: è¾“å‡ºæ•°æ®è·¯å¾„å­—å…¸
  - `columns`: éœ€è¦åˆ†ç®±çš„åˆ—ååˆ—è¡¨
  - `n_bins`: åˆ†ç®±æ•°é‡ï¼Œé»˜è®¤5

### 4. FillNAå­æ¨¡å—

#### FillNAï¼ˆç¼ºå¤±å€¼å¡«å……ï¼‰
- **æ–‡ä»¶**: `fillna/fillna_task.py`
- **ä»»åŠ¡ç±»å‹**: `fillna`
- **åŠŸèƒ½**: ä½¿ç”¨æŒ‡å®šç­–ç•¥å¡«å……ç¼ºå¤±å€¼
- **å‚æ•°**:
  - `input_data`: è¾“å…¥æ•°æ®è·¯å¾„å­—å…¸
  - `output_data`: è¾“å‡ºæ•°æ®è·¯å¾„å­—å…¸
  - `columns`: éœ€è¦å¡«å……çš„åˆ—ååˆ—è¡¨
  - `strategy`: å¡«å……ç­–ç•¥ï¼ˆ'mean'/'median'/'mode'/'constant'ï¼‰
  - `fill_value`: å½“strategy='constant'æ—¶çš„å¡«å……å€¼

## ä»£ç å˜æ›´ç»Ÿè®¡

### æ–°å»ºæ–‡ä»¶

| æ–‡ä»¶ | è¡Œæ•° | è¯´æ˜ |
|-----|------|------|
| `preprocessing/__init__.py` | 28 | æ¨¡å—å¯¼å‡º |
| `scaler/__init__.py` | 15 | Scalerå­æ¨¡å—å¯¼å‡º |
| `scaler/standard_scaler_task.py` | 206 | StandardScalerä»»åŠ¡ |
| `scaler/minmax_scaler_task.py` | 162 | MinMaxScalerä»»åŠ¡ |
| `encoder/__init__.py` | 15 | Encoderå­æ¨¡å—å¯¼å‡º |
| `encoder/label_encoder_task.py` | 153 | LabelEncoderä»»åŠ¡ |
| `encoder/onehot_encoder_task.py` | 166 | OneHotEncoderä»»åŠ¡ |
| `binning/__init__.py` | 15 | Binningå­æ¨¡å—å¯¼å‡º |
| `binning/quantile_binning_task.py` | 110 | ç­‰é¢‘åˆ†ç®±ä»»åŠ¡ |
| `binning/equal_width_binning_task.py` | 108 | ç­‰å®½åˆ†ç®±ä»»åŠ¡ |
| `fillna/__init__.py` | 11 | FillNAå­æ¨¡å—å¯¼å‡º |
| `fillna/fillna_task.py` | 125 | ç¼ºå¤±å€¼å¡«å……ä»»åŠ¡ |

**æ€»è®¡**: 12ä¸ªæ–°æ–‡ä»¶ï¼Œçº¦1,114è¡Œä»£ç 

### ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|-----|---------|
| `jobs/__init__.py` | æ·»åŠ preprocessingæ¨¡å—å¯¼å‡º |
| `docs/04.2.secretpad_work_list.md` | æ›´æ–°ä»»åŠ¡çŠ¶æ€å’Œæ–‡ä»¶è·¯å¾„ |

### ä¿ç•™æ–‡ä»¶

- `preprocessing_task.py`: ä¿ç•™åŸæ–‡ä»¶ï¼Œå¾…åç»­åˆ é™¤

## æŠ€æœ¯å®ç°

### 1. ä»»åŠ¡æ³¨å†Œ

æ‰€æœ‰ä»»åŠ¡ä½¿ç”¨`@TaskDispatcher.register_task()`è£…é¥°å™¨æ³¨å†Œï¼š

```python
@TaskDispatcher.register_task("minmax_scaler")
def execute_minmax_scaler(devices: Dict[str, PYU], task_config: Dict) -> Dict:
    """æ‰§è¡ŒMinMaxScalerå½’ä¸€åŒ–ä»»åŠ¡"""
    pass
```

### 2. é…ç½®éªŒè¯

æ¯ä¸ªä»»åŠ¡éƒ½æœ‰ç‹¬ç«‹çš„é…ç½®éªŒè¯å‡½æ•°ï¼š

```python
def _validate_minmax_scaler_config(task_config: Dict) -> None:
    """éªŒè¯MinMaxScalerä»»åŠ¡é…ç½®"""
    required_fields = ["input_data", "output_data"]
    for field in required_fields:
        if field not in task_config:
            raise ValueError(f"ç¼ºå°‘å¿…éœ€å­—æ®µ: {field}")
```

### 3. å‚ç›´è”é‚¦å­¦ä¹ æ”¯æŒ

æ‰€æœ‰ä»»åŠ¡æ”¯æŒå‚ç›´åˆ†åŒºæ•°æ®ï¼š

```python
# è¯»å–å‚ç›´åˆ†åŒºæ•°æ®
pyu_input_paths = {devices[party]: input_data[party] for party in parties}
vdf: VDataFrame = sf.data.vertical.read_csv(pyu_input_paths)

# å¯¹æ¯ä¸ªå‚ä¸æ–¹çš„æ•°æ®è¿›è¡Œå¤„ç†
for party in parties:
    pyu = devices[party]
    vdf.partitions[pyu] = pyu(process_function)(vdf.partitions[pyu], params)
```

### 4. æ—¥å¿—è®°å½•

ä½¿ç”¨ç»Ÿä¸€çš„loguruæ—¥å¿—ç³»ç»Ÿï¼š

```python
from utils.log import logger

logger.info("å¼€å§‹æ‰§è¡ŒMinMaxScalerå½’ä¸€åŒ–ä»»åŠ¡")
logger.error(f"MinMaxScalerä»»åŠ¡æ‰§è¡Œå¤±è´¥: {e}", exc_info=True)
```

## ä½¿ç”¨ç¤ºä¾‹

### StandardScalerç¤ºä¾‹

```python
devices = {
    "alice": sf.PYU('alice'),
    "bob": sf.PYU('bob'),
    "spu": sf.SPU(...)
}

task_config = {
    "input_data": {
        "alice": "/data/alice_train.csv",
        "bob": "/data/bob_train.csv"
    },
    "output_data": {
        "alice": "/data/alice_scaled.csv",
        "bob": "/data/bob_scaled.csv"
    },
    "columns": ["age", "income", "score"],
    "with_mean": True,
    "with_std": True
}

result = TaskDispatcher.dispatch("standard_scaler", devices, task_config)
```

### LabelEncoderç¤ºä¾‹

```python
task_config = {
    "input_data": {
        "alice": "/data/alice_train.csv",
        "bob": "/data/bob_train.csv"
    },
    "output_data": {
        "alice": "/data/alice_encoded.csv",
        "bob": "/data/bob_encoded.csv"
    },
    "columns": ["gender", "education", "occupation"]
}

result = TaskDispatcher.dispatch("label_encoder", devices, task_config)
```

### FillNAç¤ºä¾‹

```python
task_config = {
    "input_data": {
        "alice": "/data/alice_train.csv",
        "bob": "/data/bob_train.csv"
    },
    "output_data": {
        "alice": "/data/alice_filled.csv",
        "bob": "/data/bob_filled.csv"
    },
    "columns": ["age", "income"],
    "strategy": "mean"  # æˆ– "median", "mode", "constant"
}

result = TaskDispatcher.dispatch("fillna", devices, task_config)
```

## ä¸SecretFlowçš„å¯¹åº”å…³ç³»

| SecretFlowæ¨¡å— | æˆ‘ä»¬çš„ä»»åŠ¡ | è¯´æ˜ |
|---------------|-----------|------|
| `secretflow.preprocessing.StandardScaler` | `standard_scaler` | æ ‡å‡†åŒ– |
| `secretflow.preprocessing.scaler` | `minmax_scaler` | å½’ä¸€åŒ–ï¼ˆè‡ªå®ç°ï¼‰ |
| `sklearn.preprocessing.LabelEncoder` | `label_encoder` | æ ‡ç­¾ç¼–ç  |
| `sklearn.preprocessing.OneHotEncoder` | `onehot_encoder` | ç‹¬çƒ­ç¼–ç  |
| `pandas.qcut` | `quantile_binning` | ç­‰é¢‘åˆ†ç®± |
| `pandas.cut` | `equal_width_binning` | ç­‰å®½åˆ†ç®± |
| `pandas.fillna` | `fillna` | ç¼ºå¤±å€¼å¡«å…… |

## åç»­å·¥ä½œ

### å¾…å®Œæˆä»»åŠ¡

1. **å•å…ƒæµ‹è¯•**: ä¸ºæ‰€æœ‰é¢„å¤„ç†ä»»åŠ¡æ·»åŠ å•å…ƒæµ‹è¯•
2. **é›†æˆæµ‹è¯•**: æµ‹è¯•ä»»åŠ¡ä¹‹é—´çš„ç»„åˆä½¿ç”¨
3. **æ€§èƒ½ä¼˜åŒ–**: ä¼˜åŒ–å¤§æ•°æ®é›†çš„å¤„ç†æ€§èƒ½
4. **æ–‡æ¡£å®Œå–„**: æ·»åŠ æ›´è¯¦ç»†çš„ä½¿ç”¨æ–‡æ¡£å’Œç¤ºä¾‹

### æ‰©å±•æ–¹å‘

1. **æ›´å¤šScaler**: æ·»åŠ RobustScalerã€MaxAbsScalerç­‰
2. **æ›´å¤šEncoder**: æ·»åŠ TargetEncoderã€FrequencyEncoderç­‰
3. **é«˜çº§åˆ†ç®±**: æ·»åŠ WOEåˆ†ç®±ã€å¡æ–¹åˆ†ç®±ç­‰
4. **ç‰¹å¾é€‰æ‹©**: æ·»åŠ ç‰¹å¾é€‰æ‹©ç›¸å…³ä»»åŠ¡
5. **ç‰¹å¾å·¥ç¨‹**: æ·»åŠ ç‰¹å¾äº¤å‰ã€å¤šé¡¹å¼ç‰¹å¾ç­‰

## æœ€ä½³å®è·µ

### 1. æ¨¡å—åŒ–è®¾è®¡

- æ¯ä¸ªä»»åŠ¡ç‹¬ç«‹æ–‡ä»¶
- æŒ‰åŠŸèƒ½åˆ†ç±»ç»„ç»‡
- æ¸…æ™°çš„æ¨¡å—å¯¼å‡º

### 2. é…ç½®éªŒè¯

- ä¸¥æ ¼çš„å‚æ•°éªŒè¯
- æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
- ç±»å‹æ£€æŸ¥

### 3. é”™è¯¯å¤„ç†

- å®Œæ•´çš„å¼‚å¸¸æ•è·
- è¯¦ç»†çš„æ—¥å¿—è®°å½•
- å‹å¥½çš„é”™è¯¯æç¤º

### 4. ä»£ç å¤ç”¨

- æå–å…¬å…±é€»è¾‘
- ä½¿ç”¨è£…é¥°å™¨æ¨¡å¼
- ç»Ÿä¸€çš„æ¥å£è®¾è®¡

## æ€»ç»“

### é‡æ„æˆæœ

1. âœ… **ç›®å½•ç»“æ„æ¸…æ™°**
   - æŒ‰åŠŸèƒ½åˆ†ç±»ç»„ç»‡
   - æ˜“äºæŸ¥æ‰¾å’Œç»´æŠ¤
   - ç¬¦åˆSecretFlowé£æ ¼

2. âœ… **åŠŸèƒ½å®Œæ•´**
   - 7ä¸ªé¢„å¤„ç†ä»»åŠ¡
   - è¦†ç›–å¸¸ç”¨åœºæ™¯
   - æ”¯æŒå‚ç›´è”é‚¦å­¦ä¹ 

3. âœ… **ä»£ç è´¨é‡é«˜**
   - ç»Ÿä¸€çš„æ—¥å¿—ç³»ç»Ÿ
   - å®Œæ•´çš„é”™è¯¯å¤„ç†
   - æ¸…æ™°çš„æ–‡æ¡£æ³¨é‡Š

4. âœ… **æ˜“äºæ‰©å±•**
   - æ¨¡å—åŒ–è®¾è®¡
   - ç‹¬ç«‹çš„ä»»åŠ¡æ–‡ä»¶
   - ç»Ÿä¸€çš„æ¥å£

### æ ¸å¿ƒä¼˜åŠ¿

**ä»å•æ–‡ä»¶åˆ°æ¨¡å—åŒ–**:
- æ›´å¥½çš„ä»£ç ç»„ç»‡
- æ›´å®¹æ˜“ç»´æŠ¤
- æ›´æ–¹ä¾¿æ‰©å±•
- æ›´ç¬¦åˆå·¥ç¨‹è§„èŒƒ

**é¢„å¤„ç†ä»»åŠ¡æ¨¡å—é‡æ„å®Œæˆï¼** ğŸ‰
