# SecretFlowç”Ÿäº§éƒ¨ç½²è®¾è®¡æ–¹æ¡ˆ - Hostç½‘ç»œæ¨¡å¼

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

- **ç‰ˆæœ¬**ï¼šv2.0
- **åˆ›å»ºæ—¶é—´**ï¼š2026å¹´1æœˆ6æ—¥
- **é€‚ç”¨åœºæ™¯**ï¼šç”Ÿäº§ç¯å¢ƒå¤šèŠ‚ç‚¹éƒ¨ç½²
- **ç½‘ç»œæ¨¡å¼**ï¼šHost Network
- **å‚è€ƒæ–‡æ¡£**ï¼š[SecretFlowå®˜æ–¹éƒ¨ç½²æ–‡æ¡£](https://github.com/secretflow/secretflow/blob/main/docs/getting_started/deployment.md)

---

## ğŸ¯ è®¾è®¡ç›®æ ‡

1. **ç¬¦åˆå®˜æ–¹æœ€ä½³å®è·µ**ï¼šä¸¥æ ¼éµå¾ªSecretFlowå®˜æ–¹æ¨èçš„ç”Ÿäº§éƒ¨ç½²æ–¹å¼
2. **ç®€åŒ–é…ç½®**ï¼šå‡å°‘å¤æ‚çš„ç«¯å£æ˜ å°„å’Œç½‘ç»œé…ç½®
3. **æ€§èƒ½æœ€ä¼˜**ï¼šä½¿ç”¨hostç½‘ç»œæ¨¡å¼ï¼Œé¿å…NATè½¬æ¢å¼€é”€
4. **æ˜“äºæ‰©å±•**ï¼šæ”¯æŒå¤šèŠ‚ç‚¹ã€å¤šæœåŠ¡å™¨éƒ¨ç½²
5. **ç¨³å®šå¯é **ï¼šé¿å…ä¹‹å‰æ–¹æ¡ˆä¸­çš„å…¼å®¹æ€§å’Œé…ç½®é—®é¢˜

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å®¿ä¸»æœº (Host Network)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   Redis      â”‚  â”‚  Ray Head    â”‚  â”‚    Celery    â”‚      â”‚
â”‚  â”‚  (60379)     â”‚  â”‚   (61379)     â”‚  â”‚    Worker    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                               â”‚
â”‚  ç«¯å£ä½¿ç”¨ï¼š                                                   â”‚
â”‚  - Redis: 60379 (Celeryä»»åŠ¡é˜Ÿåˆ—)                            â”‚
â”‚  - Ray GCS: 61379 (Rayé›†ç¾¤é€šä¿¡)                              â”‚
â”‚  - SecretFlow: 19000-19009 (èŠ‚ç‚¹é€šä¿¡)                       â”‚
â”‚  - SPU: 19500-19509 (å®‰å…¨è®¡ç®—åè®®)                          â”‚
â”‚  - HEU: 19800-19809 (åŒæ€åŠ å¯†)                              â”‚
â”‚  - Celeryç›‘æ§: 8088                                         â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¤šèŠ‚ç‚¹éƒ¨ç½²æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   èŠ‚ç‚¹1 (å¤´èŠ‚ç‚¹)      â”‚         â”‚   èŠ‚ç‚¹2 (å·¥ä½œèŠ‚ç‚¹)    â”‚
â”‚   192.168.1.10       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   192.168.1.11       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Redis: 60379         â”‚         â”‚ Redis: 60379         â”‚
â”‚ Ray Head: 61379       â”‚         â”‚ Ray Worker           â”‚
â”‚ Worker               â”‚         â”‚ Worker               â”‚
â”‚ SF: 19000-19009      â”‚         â”‚ SF: 19100-19109      â”‚
â”‚ SPU: 19500-19509     â”‚         â”‚ SPU: 19600-19609     â”‚
â”‚ HEU: 19800-19809     â”‚         â”‚ HEU: 19859-19899     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
              ç›´æ¥é€šè¿‡å®¿ä¸»æœºç½‘ç»œé€šä¿¡
              æ— éœ€ç«¯å£æ˜ å°„ï¼Œæ— NATå¼€é”€
```

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
secretflow-worker/
â”œâ”€â”€ docker/
â”‚   â”œâ”€â”€ docker-compose.production.yml    # Hostç½‘ç»œé…ç½®
â”‚   â”œâ”€â”€ docker-compose.head.yml          # Rayå¤´èŠ‚ç‚¹é…ç½®
â”‚   â”œâ”€â”€ docker-compose.worker.yml        # Rayå·¥ä½œèŠ‚ç‚¹é…ç½®
â”‚   â””â”€â”€ Dockerfile                       # å®¹å™¨é•œåƒå®šä¹‰
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ production.env.template          # ç”Ÿäº§ç¯å¢ƒé…ç½®æ¨¡æ¿
â”‚   â”œâ”€â”€ node1.env                        # èŠ‚ç‚¹1é…ç½®ç¤ºä¾‹
â”‚   â””â”€â”€ node2.env                        # èŠ‚ç‚¹2é…ç½®ç¤ºä¾‹
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ start_ray_head.sh               # Rayå¤´èŠ‚ç‚¹å¯åŠ¨è„šæœ¬
â”‚   â”œâ”€â”€ start_ray_worker.sh             # Rayå·¥ä½œèŠ‚ç‚¹å¯åŠ¨è„šæœ¬
â”‚   â”œâ”€â”€ entrypoint.sh                   # å®¹å™¨å…¥å£è„šæœ¬
â”‚   â””â”€â”€ deploy.sh                        # ä¸€é”®éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ src/
â”‚   â””â”€â”€ worker.py                        # Celery Worker (ç§»é™¤Rayåˆå§‹åŒ–)
â””â”€â”€ docs/
    â”œâ”€â”€ deployment_guide.md              # éƒ¨ç½²æŒ‡å—
    â””â”€â”€ troubleshooting.md               # æ•…éšœæ’æŸ¥
```

---

## ğŸ”§ è¯¦ç»†è®¾è®¡

### 1. Docker Composeé…ç½®

#### 1.1 ç”Ÿäº§ç¯å¢ƒé…ç½® (docker-compose.production.yml)

```yaml
version: '3.8'

services:
  # RedisæœåŠ¡ - Celeryä»»åŠ¡é˜Ÿåˆ—
  redis:
    image: redis:7-alpine
    container_name: ${NODE_ID}-redis
    network_mode: "host"
    command: >
      redis-server
      --port ${REDIS_PORT}
      --maxmemory 2gb
      --maxmemory-policy allkeys-lru
      --appendonly yes
      --appendfsync everysec
    volumes:
      - redis_data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "${REDIS_PORT}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # WorkeræœåŠ¡ - Celery + Ray
  worker:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: secretflow-worker:latest
    container_name: ${NODE_ID}-worker
    network_mode: "host"
    depends_on:
      redis:
        condition: service_healthy
    env_file:
      - ../.env.production
    volumes:
      - worker_data:/app/data
      - worker_logs:/app/logs
      - /dev/shm:/dev/shm
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "-f", "python src/worker.py"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 60s

volumes:
  redis_data:
    driver: local
  worker_data:
    driver: local
  worker_logs:
    driver: local
```

**å…³é”®å˜åŒ–**ï¼š
- âœ… ä½¿ç”¨`network_mode: "host"`æ›¿ä»£bridgeç½‘ç»œ
- âœ… ç§»é™¤æ‰€æœ‰`ports`æ˜ å°„é…ç½®
- âœ… Redisç›´æ¥ç›‘å¬å®¿ä¸»æœºç«¯å£
- âœ… ç®€åŒ–å¥åº·æ£€æŸ¥

---

### 2. ç¯å¢ƒå˜é‡é…ç½®

#### 2.1 é…ç½®æ¨¡æ¿ (config/production.env.template)

```bash
# ========================================
# SecretFlowç”Ÿäº§ç¯å¢ƒé…ç½®æ¨¡æ¿ (Hostç½‘ç»œæ¨¡å¼)
# ========================================

# ========== èŠ‚ç‚¹åŸºç¡€é…ç½® ==========
# èŠ‚ç‚¹å”¯ä¸€æ ‡è¯†ç¬¦
NODE_ID=node1

# èŠ‚ç‚¹IPåœ°å€ï¼ˆå®¿ä¸»æœºçœŸå®IPï¼Œç”¨äºå¤šèŠ‚ç‚¹é€šä¿¡ï¼‰
NODE_IP=192.168.1.10

# è¿è¡Œç¯å¢ƒ
APP_ENV=production

# ========== Redisé…ç½® ==========
# Redisä¸»æœºåœ°å€ï¼ˆhostæ¨¡å¼ä¸‹ä½¿ç”¨127.0.0.1ï¼‰
REDIS_HOST=127.0.0.1

# Redisç«¯å£ï¼ˆå»ºè®®ä½¿ç”¨éæ ‡å‡†ç«¯å£é¿å…å†²çªï¼‰
REDIS_PORT=60379

# Redisæ•°æ®åº“ç¼–å·
REDIS_DB=0

# Rediså¯†ç ï¼ˆå¯é€‰ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®è®¾ç½®ï¼‰
REDIS_PASSWORD=

# ========== Rayé›†ç¾¤é…ç½® ==========
# Rayé›†ç¾¤ç±»å‹ï¼šheadï¼ˆå¤´èŠ‚ç‚¹ï¼‰æˆ– workerï¼ˆå·¥ä½œèŠ‚ç‚¹ï¼‰
RAY_NODE_TYPE=head

# Rayå¤´èŠ‚ç‚¹åœ°å€ï¼ˆå·¥ä½œèŠ‚ç‚¹éœ€è¦è¿æ¥åˆ°å¤´èŠ‚ç‚¹ï¼‰
# æ ¼å¼ï¼š<å¤´èŠ‚ç‚¹IP>:<Rayç«¯å£>
RAY_HEAD_ADDRESS=192.168.1.10:61379

# å½“å‰èŠ‚ç‚¹IPåœ°å€
RAY_NODE_IP=192.168.1.10

# Ray GCSç«¯å£ï¼ˆå¤´èŠ‚ç‚¹ä½¿ç”¨ï¼‰
RAY_PORT=61379

# Rayä½¿ç”¨çš„CPUæ•°é‡ï¼ˆ0è¡¨ç¤ºä½¿ç”¨å…¨éƒ¨CPUï¼‰
RAY_NUM_CPUS=0

# Rayå¯¹è±¡å­˜å‚¨å†…å­˜å¤§å°ï¼ˆå­—èŠ‚ï¼‰
RAY_OBJECT_STORE_MEMORY=2000000000

# ========== SecretFlowç«¯å£èŒƒå›´é…ç½® ==========
# SecretFlowé€šä¿¡ç«¯å£èŒƒå›´
# æ³¨æ„ï¼šä¸åŒèŠ‚ç‚¹éœ€è¦ä½¿ç”¨ä¸åŒçš„ç«¯å£èŒƒå›´é¿å…å†²çª
# èŠ‚ç‚¹1: 19000-19009
# èŠ‚ç‚¹2: 19100-19109
# èŠ‚ç‚¹3: 19200-19299
SF_PORT_RANGE_START=19000
SF_PORT_RANGE_END=19009

# SPUèŠ‚ç‚¹ç«¯å£èŒƒå›´
SPU_PORT_RANGE_START=19500
SPU_PORT_RANGE_END=19509

# HEUèŠ‚ç‚¹ç«¯å£èŒƒå›´ï¼ˆå¯é€‰ï¼‰
HEU_PORT_RANGE_START=19800
HEU_PORT_RANGE_END=19809

# ========== Celery Workeré…ç½® ==========
# Workerå¹¶å‘æ•°ï¼ˆå»ºè®®è®¾ç½®ä¸ºCPUæ ¸å¿ƒæ•°çš„1-2å€ï¼‰
WORKER_CONCURRENCY=2

# Workerä¸»æœºå
WORKER_HOSTNAME=${NODE_ID}@127.0.0.1

# Workeræ—¥å¿—çº§åˆ«
CELERY_LOG_LEVEL=INFO

# Workerä»»åŠ¡é˜Ÿåˆ—
WORKER_QUEUES=secretflow_queue

# ========== Celeryä»»åŠ¡é…ç½® ==========
# ä»»åŠ¡è½¯è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
WORKER_TASK_SOFT_TIME_LIMIT=3600

# ä»»åŠ¡ç¡¬è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
WORKER_TASK_TIME_LIMIT=3900

# æ¯ä¸ªå­è¿›ç¨‹æœ€å¤§ä»»åŠ¡æ•°
WORKER_MAX_TASKS_PER_CHILD=100

# é¢„å–ä»»åŠ¡å€æ•°
WORKER_PREFETCH_MULTIPLIER=1

# ========== Celeryç›‘æ§ç«¯å£ ==========
CELERY_MONITOR_PORT=8088

# ========== æ—¥å¿—é…ç½® ==========
LOG_LEVEL=INFO
LOG_PATH=/app/logs

# ========== æ•°æ®ç›®å½• ==========
DATA_PATH=/app/data
```

#### 2.2 èŠ‚ç‚¹é…ç½®ç¤ºä¾‹

**èŠ‚ç‚¹1é…ç½® (config/node1.env)**ï¼š
```bash
NODE_ID=node1
NODE_IP=192.168.1.10
RAY_NODE_TYPE=head
RAY_HEAD_ADDRESS=192.168.1.10:61379
SF_PORT_RANGE_START=19000
SF_PORT_RANGE_END=19009
SPU_PORT_RANGE_START=19500
SPU_PORT_RANGE_END=19509
HEU_PORT_RANGE_START=19800
HEU_PORT_RANGE_END=19809
```

**èŠ‚ç‚¹2é…ç½® (config/node2.env)**ï¼š
```bash
NODE_ID=node2
NODE_IP=192.168.1.11
RAY_NODE_TYPE=worker
RAY_HEAD_ADDRESS=192.168.1.10:61379
SF_PORT_RANGE_START=19100
SF_PORT_RANGE_END=19109
SPU_PORT_RANGE_START=19600
SPU_PORT_RANGE_END=19609
HEU_PORT_RANGE_START=19859
HEU_PORT_RANGE_END=19899
```

---

### 3. Rayå¯åŠ¨è„šæœ¬

#### 3.1 Rayå¤´èŠ‚ç‚¹å¯åŠ¨è„šæœ¬ (scripts/start_ray_head.sh)

```bash
#!/bin/bash
set -e

echo "ğŸš€ å¯åŠ¨Rayå¤´èŠ‚ç‚¹..."

# æ£€æŸ¥å¿…è¦çš„ç¯å¢ƒå˜é‡
if [ -z "$RAY_NODE_IP" ]; then
    echo "âŒ é”™è¯¯ï¼šRAY_NODE_IPç¯å¢ƒå˜é‡æœªè®¾ç½®"
    exit 1
fi

# å¯åŠ¨Rayå¤´èŠ‚ç‚¹
ray start \
    --head \
    --port=${RAY_PORT:-61379} \
    --node-ip-address=${RAY_NODE_IP} \
    --num-cpus=${RAY_NUM_CPUS:-0} \
    --object-store-memory=${RAY_OBJECT_STORE_MEMORY:-2000000000} \
    --include-dashboard=false \
    --block

echo "âœ… Rayå¤´èŠ‚ç‚¹å¯åŠ¨æˆåŠŸ"
```

#### 3.2 Rayå·¥ä½œèŠ‚ç‚¹å¯åŠ¨è„šæœ¬ (scripts/start_ray_worker.sh)

```bash
#!/bin/bash
set -e

echo "ğŸš€ å¯åŠ¨Rayå·¥ä½œèŠ‚ç‚¹..."

# æ£€æŸ¥å¿…è¦çš„ç¯å¢ƒå˜é‡
if [ -z "$RAY_HEAD_ADDRESS" ]; then
    echo "âŒ é”™è¯¯ï¼šRAY_HEAD_ADDRESSç¯å¢ƒå˜é‡æœªè®¾ç½®"
    exit 1
fi

if [ -z "$RAY_NODE_IP" ]; then
    echo "âŒ é”™è¯¯ï¼šRAY_NODE_IPç¯å¢ƒå˜é‡æœªè®¾ç½®"
    exit 1
fi

# ç­‰å¾…å¤´èŠ‚ç‚¹å°±ç»ª
echo "â³ ç­‰å¾…Rayå¤´èŠ‚ç‚¹å°±ç»ª..."
max_retries=30
retry_count=0

while [ $retry_count -lt $max_retries ]; do
    if ray health-check --address=${RAY_HEAD_ADDRESS} 2>/dev/null; then
        echo "âœ… Rayå¤´èŠ‚ç‚¹å·²å°±ç»ª"
        break
    fi
    retry_count=$((retry_count + 1))
    echo "ç­‰å¾…ä¸­... ($retry_count/$max_retries)"
    sleep 2
done

if [ $retry_count -eq $max_retries ]; then
    echo "âŒ é”™è¯¯ï¼šæ— æ³•è¿æ¥åˆ°Rayå¤´èŠ‚ç‚¹ ${RAY_HEAD_ADDRESS}"
    exit 1
fi

# å¯åŠ¨Rayå·¥ä½œèŠ‚ç‚¹
ray start \
    --address=${RAY_HEAD_ADDRESS} \
    --node-ip-address=${RAY_NODE_IP} \
    --num-cpus=${RAY_NUM_CPUS:-0} \
    --object-store-memory=${RAY_OBJECT_STORE_MEMORY:-2000000000} \
    --block

echo "âœ… Rayå·¥ä½œèŠ‚ç‚¹å¯åŠ¨æˆåŠŸ"
```

#### 3.3 å®¹å™¨å…¥å£è„šæœ¬ (scripts/entrypoint.sh)

```bash
#!/bin/bash
set -e

echo "ğŸš€ å¯åŠ¨SecretFlow Workerå®¹å™¨..."

# æ ¹æ®èŠ‚ç‚¹ç±»å‹å¯åŠ¨Ray
if [ "$RAY_NODE_TYPE" = "head" ]; then
    echo "ğŸ“‹ èŠ‚ç‚¹ç±»å‹ï¼šRayå¤´èŠ‚ç‚¹"
    /app/scripts/start_ray_head.sh &
elif [ "$RAY_NODE_TYPE" = "worker" ]; then
    echo "ğŸ“‹ èŠ‚ç‚¹ç±»å‹ï¼šRayå·¥ä½œèŠ‚ç‚¹"
    /app/scripts/start_ray_worker.sh &
else
    echo "âŒ é”™è¯¯ï¼šæœªçŸ¥çš„RAY_NODE_TYPE: $RAY_NODE_TYPE"
    exit 1
fi

RAY_PID=$!

# ç­‰å¾…Rayå¯åŠ¨å®Œæˆ
sleep 5

# éªŒè¯Rayæ˜¯å¦è¿è¡Œ
if ! ps -p $RAY_PID > /dev/null; then
    echo "âŒ Rayå¯åŠ¨å¤±è´¥"
    exit 1
fi

echo "âœ… Rayå¯åŠ¨æˆåŠŸ"

# å¯åŠ¨Celery Worker
echo "ğŸš€ å¯åŠ¨Celery Worker..."
exec python src/worker.py
```

---

### 4. Dockerfileè°ƒæ•´

```dockerfile
FROM python:3.10.16-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# åˆ›å»ºå¿…è¦çš„ç›®å½•
RUN mkdir -p /app/data /app/logs /tmp/secretflow

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    git \
    curl \
    wget \
    procps \
    net-tools \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£…Pythonä¾èµ–
COPY requirements.txt /app/
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY src/ /app/src/
COPY scripts/ /app/scripts/
COPY docker/ /app/docker/
COPY main.py /app/
COPY .env.docker /app/.env

# è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
RUN chmod +x /app/scripts/*.sh

# åˆ›å»ºérootç”¨æˆ·
RUN groupadd -r secretflow && \
    useradd -r -g secretflow -m -s /bin/bash secretflow && \
    chown -R secretflow:secretflow /app /tmp/secretflow

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER secretflow

# ä½¿ç”¨å…¥å£è„šæœ¬
ENTRYPOINT ["/app/scripts/entrypoint.sh"]
```

---

### 5. Workerä»£ç è°ƒæ•´

```python
# src/worker.py

def main():
    """å¯åŠ¨Celery Workerä¸»å‡½æ•°"""
    logger.info("ğŸš€ å¯åŠ¨SecretFlow Celery Worker...")

    try:
        # è®¾ç½®ç¯å¢ƒå˜é‡
        os.environ.setdefault("CELERY_APP", "src.celery_app:celery_app")

        # éªŒè¯ç¯å¢ƒ
        validate_environment()
        
        # âŒ ç§»é™¤ï¼šä¸å†åœ¨Workerä¸­åˆå§‹åŒ–Ray
        # Rayå·²é€šè¿‡å®¹å™¨å¯åŠ¨è„šæœ¬åœ¨åå°è¿è¡Œ
        
        # è®¾ç½®ä¿¡å·å¤„ç†
        setup_signal_handlers()

        # æ˜¾ç¤ºå¯åŠ¨ä¿¡æ¯
        logger.info("ğŸ“‹ Workeré…ç½®:")
        logger.info(f"   èŠ‚ç‚¹ID: {settings.node_id}")
        logger.info(f"   å¹¶å‘æ•°: {settings.worker_concurrency}")
        logger.info(f"   é˜Ÿåˆ—: {settings.worker_queues}")
        
        # å¯åŠ¨Celery Worker
        celery_app.start()

    except KeyboardInterrupt:
        logger.info("ğŸ“‹ Workerè¢«ç”¨æˆ·ä¸­æ–­")
    except Exception as e:
        logger.error(f"âŒ Workerå¯åŠ¨å¤±è´¥: {e}")
        sys.exit(1)
    finally:
        logger.info("ğŸ‘‹ SecretFlow Workerå·²åœæ­¢")
```

---

## ğŸš€ éƒ¨ç½²æµç¨‹

### å•èŠ‚ç‚¹éƒ¨ç½²

```bash
# 1. å‡†å¤‡é…ç½®æ–‡ä»¶
cd /path/to/secretflow-worker
cp config/production.env.template .env.production

# 2. ç¼–è¾‘é…ç½®ï¼ˆè®¾ç½®NODE_IPç­‰ï¼‰
vim .env.production

# 3. æ„å»ºé•œåƒ
docker build -f docker/Dockerfile -t secretflow-worker:latest .

# 4. å¯åŠ¨æœåŠ¡
docker compose -f docker/docker-compose.production.yml \
    --env-file .env.production up -d

# 5. æŸ¥çœ‹æ—¥å¿—
docker logs -f node1-worker

# 6. éªŒè¯Rayé›†ç¾¤
docker exec node1-worker ray status
```

### å¤šèŠ‚ç‚¹éƒ¨ç½²

**èŠ‚ç‚¹1ï¼ˆå¤´èŠ‚ç‚¹ï¼‰**ï¼š
```bash
# ä½¿ç”¨node1.envé…ç½®
cp config/node1.env .env.production
docker compose -f docker/docker-compose.production.yml \
    --env-file .env.production up -d
```

**èŠ‚ç‚¹2ï¼ˆå·¥ä½œèŠ‚ç‚¹ï¼‰**ï¼š
```bash
# ä½¿ç”¨node2.envé…ç½®
cp config/node2.env .env.production
docker compose -f docker/docker-compose.production.yml \
    --env-file .env.production up -d
```

**éªŒè¯é›†ç¾¤**ï¼š
```bash
# åœ¨ä»»æ„èŠ‚ç‚¹æ‰§è¡Œ
docker exec node1-worker ray status
# åº”è¯¥çœ‹åˆ°2ä¸ªèŠ‚ç‚¹
```

---

## âœ… æ–¹æ¡ˆä¼˜åŠ¿

### 1. ç¬¦åˆå®˜æ–¹æœ€ä½³å®è·µ
- âœ… ä½¿ç”¨hostç½‘ç»œæ¨¡å¼
- âœ… ä½¿ç”¨ray startå‘½ä»¤è¡Œå¯åŠ¨
- âœ… éµå¾ªå®˜æ–¹éƒ¨ç½²æ–‡æ¡£

### 2. é…ç½®ç®€å•æ¸…æ™°
- âœ… æ— éœ€å¤æ‚çš„ç«¯å£æ˜ å°„
- âœ… ç¯å¢ƒå˜é‡é…ç½®ç›´è§‚
- âœ… æ˜“äºç†è§£å’Œç»´æŠ¤

### 3. æ€§èƒ½æœ€ä¼˜
- âœ… æ— NATè½¬æ¢å¼€é”€
- âœ… ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºç½‘ç»œ
- âœ… å¤šèŠ‚ç‚¹é€šä¿¡å»¶è¿Ÿæœ€ä½

### 4. æ˜“äºæ‰©å±•
- âœ… æ·»åŠ æ–°èŠ‚ç‚¹åªéœ€å¤åˆ¶é…ç½®
- âœ… ç«¯å£èŒƒå›´è§„åˆ’æ¸…æ™°
- âœ… æ”¯æŒæ°´å¹³æ‰©å±•

### 5. ç¨³å®šå¯é 
- âœ… é¿å…Python 3.10å…¼å®¹æ€§é—®é¢˜
- âœ… Rayç‹¬ç«‹è¿›ç¨‹è¿è¡Œ
- âœ… è¿›ç¨‹éš”ç¦»ï¼Œäº’ä¸å½±å“

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ç«¯å£ç®¡ç†
- ç¡®ä¿å®¿ä¸»æœºç«¯å£æœªè¢«å ç”¨
- ä¸åŒèŠ‚ç‚¹ä½¿ç”¨ä¸åŒçš„SecretFlowç«¯å£èŒƒå›´
- å»ºè®®ä½¿ç”¨ç«¯å£æ‰«æå·¥å…·æ£€æŸ¥

### 2. é˜²ç«å¢™é…ç½®
```bash
# å…è®¸Rayé€šä¿¡
firewall-cmd --permanent --add-port=61379/tcp

# å…è®¸SecretFlowé€šä¿¡
firewall-cmd --permanent --add-port=19000-19009/tcp
firewall-cmd --permanent --add-port=19500-19509/tcp
firewall-cmd --permanent --add-port=19800-19809/tcp

# é‡è½½é˜²ç«å¢™
firewall-cmd --reload
```

### 3. å®‰å…¨å»ºè®®
- ç”Ÿäº§ç¯å¢ƒè®¾ç½®Rediså¯†ç 
- ä½¿ç”¨TLSåŠ å¯†èŠ‚ç‚¹é—´é€šä¿¡
- é™åˆ¶Ray Dashboardè®¿é—®
- å®šæœŸæ›´æ–°ä¾èµ–åŒ…

### 4. èµ„æºé™åˆ¶
è™½ç„¶ä½¿ç”¨hostç½‘ç»œï¼Œä»å¯é€šè¿‡Dockeré™åˆ¶èµ„æºï¼š
```yaml
deploy:
  resources:
    limits:
      memory: 8G
      cpus: '4'
```

---

## ğŸ“Š ä¸æ—§æ–¹æ¡ˆå¯¹æ¯”

| ç‰¹æ€§ | æ—§æ–¹æ¡ˆ(Bridge) | æ–°æ–¹æ¡ˆ(Host) |
|------|---------------|--------------|
| ç½‘ç»œæ¨¡å¼ | bridge + ç«¯å£æ˜ å°„ | host |
| Rayå¯åŠ¨ | Python API | å‘½ä»¤è¡Œ |
| ç«¯å£é…ç½® | å¤æ‚æ˜ å°„ | ç›´æ¥ä½¿ç”¨ |
| æ€§èƒ½ | æœ‰NATå¼€é”€ | æ— å¼€é”€ |
| å¤šèŠ‚ç‚¹éƒ¨ç½² | å¤æ‚ | ç®€å• |
| å®˜æ–¹æ¨è | âŒ | âœ… |
| é…ç½®å¤æ‚åº¦ | é«˜ | ä½ |
| å…¼å®¹æ€§é—®é¢˜ | æœ‰ | æ—  |

---

## ğŸ” æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

**1. Rayæ— æ³•å¯åŠ¨**
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tuln | grep 61379

# æŸ¥çœ‹Rayæ—¥å¿—
docker logs node1-worker | grep ray
```

**2. èŠ‚ç‚¹æ— æ³•è¿æ¥**
```bash
# æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
ping 192.168.1.10

# æ£€æŸ¥RayçŠ¶æ€
ray status --address=192.168.1.10:61379
```

**3. ç«¯å£å†²çª**
```bash
# æ‰«æç«¯å£ä½¿ç”¨æƒ…å†µ
nmap -p 61379,60379,19000-19009 localhost
```

---

## ğŸ“ åç»­ä»»åŠ¡

- [ ] å®æ–½æ–°æ–¹æ¡ˆ
- [ ] ç¼–å†™è¯¦ç»†éƒ¨ç½²æŒ‡å—
- [ ] æµ‹è¯•å•èŠ‚ç‚¹éƒ¨ç½²
- [ ] æµ‹è¯•å¤šèŠ‚ç‚¹éƒ¨ç½²
- [ ] æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–
- [ ] ç¼–å†™è¿ç»´æ–‡æ¡£

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv2.0  
**åˆ›å»ºæ—¶é—´**ï¼š2026å¹´1æœˆ6æ—¥  
**æœ€åæ›´æ–°**ï¼š2026å¹´1æœˆ6æ—¥  
**ä½œè€…**ï¼šSecretFlowéƒ¨ç½²å›¢é˜Ÿ
