# Celeryä»»åŠ¡å‘é€æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•æ­£ç¡®åœ°å°†ä»»åŠ¡å‘é€åˆ°Celeryé˜Ÿåˆ—ï¼Œä»¥åŠ`celery call`å’Œ`app.send_task()`çš„åŒºåˆ«ã€‚

---

## âš ï¸ é‡è¦åŒºåˆ«

### **celery call vs app.send_task()**

| ç‰¹æ€§ | `celery call` | `app.send_task()` |
|------|--------------|-------------------|
| æ‰§è¡Œæ–¹å¼ | **åŒæ­¥æ‰§è¡Œ**ï¼Œåœ¨å½“å‰è¿›ç¨‹ | **å¼‚æ­¥æ‰§è¡Œ**ï¼Œå‘é€åˆ°é˜Ÿåˆ— |
| æ˜¯å¦ä½¿ç”¨é˜Ÿåˆ— | âŒ å¦ | âœ… æ˜¯ |
| æ˜¯å¦éœ€è¦Worker | âŒ å¦ | âœ… æ˜¯ |
| é€‚ç”¨åœºæ™¯ | æœ¬åœ°æµ‹è¯•ã€è°ƒè¯• | ç”Ÿäº§ç¯å¢ƒã€åˆ†å¸ƒå¼ä»»åŠ¡ |
| è¿”å›å€¼ | ç›´æ¥è¿”å›ç»“æœ | è¿”å›AsyncResultå¯¹è±¡ |

**å…³é”®ç‚¹**ï¼š
- `celery call` ä¼š**ç›´æ¥åœ¨å½“å‰ç»ˆç«¯è¿›ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡**ï¼Œä¸ä¼šå‘é€åˆ°é˜Ÿåˆ—
- `app.send_task()` æ‰æ˜¯**çœŸæ­£çš„å¼‚æ­¥ä»»åŠ¡å‘é€**ï¼Œä¼šé€šè¿‡Redisé˜Ÿåˆ—åˆ†å‘ç»™Worker

---

## ğŸš€ æ¨èæ–¹æ³•ï¼šä½¿ç”¨Makefileå‘½ä»¤

### **1. å‘é€Helloæµ‹è¯•ä»»åŠ¡**
```bash
make task-hello
```

### **2. å‘é€å¥åº·æ£€æŸ¥ä»»åŠ¡**
```bash
make task-health
```

### **3. å‘é€PSIä»»åŠ¡**
```bash
make task-psi
```

### **4. äº¤äº’å¼å‘é€è‡ªå®šä¹‰ä»»åŠ¡**
```bash
make task-send
```

è¿›å…¥Pythonäº¤äº’å¼ç¯å¢ƒåï¼š
```python
# å‘é€ç®€å•ä»»åŠ¡
result = app.send_task(
    'tasks.secretflow.hello.hello_task',
    queue='secretflow_queue'
)
print(f"Task ID: {result.id}")

# ç­‰å¾…ç»“æœ
result.get(timeout=60)

# å‘é€å¸¦å‚æ•°çš„ä»»åŠ¡
result = app.send_task(
    'tasks.secretflow.execute_task',
    args=['task-001', {...}],
    queue='secretflow_queue',
    routing_key='secretflow'
)
```

---

## ğŸ“ æ–¹æ³•è¯¦è§£

### **æ–¹æ³•1ï¼šä½¿ç”¨Pythonè„šæœ¬ï¼ˆæ¨èï¼‰**

#### **åŸºç¡€ç”¨æ³•**
```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
source .venv/bin/activate

# å‘é€helloä»»åŠ¡
python scripts/send_task.py hello

# å‘é€å¥åº·æ£€æŸ¥ä»»åŠ¡
python scripts/send_task.py health

# å‘é€PSIä»»åŠ¡
python scripts/send_task.py psi
```

#### **è‡ªå®šä¹‰è„šæœ¬**
åˆ›å»ºæ‚¨è‡ªå·±çš„ä»»åŠ¡å‘é€è„šæœ¬ï¼š

```python
from src.celery_app import app

# å‘é€ä»»åŠ¡åˆ°æŒ‡å®šé˜Ÿåˆ—
result = app.send_task(
    'tasks.secretflow.execute_task',  # ä»»åŠ¡åç§°
    args=[task_id, task_params],      # ä»»åŠ¡å‚æ•°
    queue='secretflow_queue',         # ç›®æ ‡é˜Ÿåˆ—
    routing_key='secretflow'          # è·¯ç”±é”®
)

print(f"ä»»åŠ¡ID: {result.id}")
print(f"ä»»åŠ¡çŠ¶æ€: {result.state}")

# ç­‰å¾…ä»»åŠ¡å®Œæˆï¼ˆå¯é€‰ï¼‰
try:
    result_data = result.get(timeout=300)
    print(f"ä»»åŠ¡ç»“æœ: {result_data}")
except Exception as e:
    print(f"ä»»åŠ¡å¤±è´¥: {e}")
```

---

### **æ–¹æ³•2ï¼šä½¿ç”¨Pythonäº¤äº’å¼ç¯å¢ƒ**

```bash
# å¯åŠ¨Pythonç¯å¢ƒ
source .venv/bin/activate
python
```

```python
from src.celery_app import app

# å‘é€helloä»»åŠ¡
result = app.send_task(
    'tasks.secretflow.hello.hello_task',
    queue='secretflow_queue'
)

# æŸ¥çœ‹ä»»åŠ¡ID
print(result.id)

# æŸ¥çœ‹ä»»åŠ¡çŠ¶æ€
print(result.state)  # PENDING, STARTED, SUCCESS, FAILURE

# ç­‰å¾…ç»“æœï¼ˆé˜»å¡ï¼‰
result.get(timeout=60)

# æ£€æŸ¥ä»»åŠ¡æ˜¯å¦æˆåŠŸ
if result.successful():
    print("ä»»åŠ¡æˆåŠŸå®Œæˆ")
    print(result.result)
```

---

### **æ–¹æ³•3ï¼šä½¿ç”¨Celery CLIå‘é€ä»»åŠ¡**

**æ³¨æ„**ï¼šè¿™æ˜¯**çœŸæ­£çš„å¼‚æ­¥å‘é€**æ–¹å¼ï¼Œä¸`celery call`ä¸åŒï¼

```bash
# ä½¿ç”¨ celery send-task å‘½ä»¤
celery -A src.celery_app send-task \
    tasks.secretflow.hello.hello_task \
    --queue=secretflow_queue

# å‘é€å¸¦å‚æ•°çš„ä»»åŠ¡
celery -A src.celery_app send-task \
    tasks.secretflow.execute_task \
    --queue=secretflow_queue \
    --args='["task-001", {"key": "value"}]'
```

---

## ğŸ¯ å®Œæ•´ç¤ºä¾‹ï¼šå‘é€PSIä»»åŠ¡

### **ä½¿ç”¨Pythonè„šæœ¬**

```python
from src.celery_app import app

task_id = "psi-test-001"
task_params = {
    "sf_init_config": {
        "parties": ["alice", "bob"],
        "address": "local"
    },
    "spu_config": {
        "cluster_def": {
            "nodes": [
                {"party": "alice", "address": "127.0.0.1:12345"},
                {"party": "bob", "address": "127.0.0.1:12346"}
            ],
            "runtime_config": {
                "protocol": "SEMI2K",
                "field": "FM128"
            }
        }
    },
    "task_config": {
        "task_type": "psi",
        "keys": "uid",
        "input_paths": {
            "alice": "/path/to/alice.csv",
            "bob": "/path/to/bob.csv"
        },
        "output_paths": {
            "alice": "/path/to/alice_out.csv",
            "bob": "/path/to/bob_out.csv"
        },
        "receiver_party": "alice",
        "protocol": "KKRT_PSI_2PC",
        "sort": True
    }
}

# å‘é€ä»»åŠ¡
result = app.send_task(
    'tasks.secretflow.execute_task',
    args=[task_id, task_params],
    queue='secretflow_queue',
    routing_key='secretflow'
)

print(f"âœ… ä»»åŠ¡å·²å‘é€")
print(f"ğŸ“‹ ä»»åŠ¡ID: {result.id}")

# ç­‰å¾…ç»“æœï¼ˆæœ€å¤š5åˆ†é’Ÿï¼‰
try:
    result_data = result.get(timeout=300)
    print(f"âœ… ä»»åŠ¡å®Œæˆ: {result_data}")
except Exception as e:
    print(f"âŒ ä»»åŠ¡å¤±è´¥: {e}")
```

---

## ğŸ” ç›‘æ§ä»»åŠ¡çŠ¶æ€

### **æŸ¥çœ‹Workeræ—¥å¿—**
```bash
# Dockerç¯å¢ƒ
make docker-logs-worker

# æˆ–ç›´æ¥ä½¿ç”¨dockerå‘½ä»¤
docker logs -f node1-worker
```

### **æ£€æŸ¥ä»»åŠ¡çŠ¶æ€**
```python
from src.celery_app import app

# é€šè¿‡ä»»åŠ¡IDè·å–ç»“æœ
result = app.AsyncResult('task-id-here')

# æ£€æŸ¥çŠ¶æ€
print(result.state)  # PENDING, STARTED, SUCCESS, FAILURE, RETRY

# è·å–ç»“æœï¼ˆå¦‚æœæˆåŠŸï¼‰
if result.successful():
    print(result.result)

# è·å–é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœå¤±è´¥ï¼‰
if result.failed():
    print(result.traceback)
```

---

## ğŸ“Š é˜Ÿåˆ—é…ç½®è¯´æ˜

### **å¯ç”¨é˜Ÿåˆ—**
é¡¹ç›®ä¸­é…ç½®äº†ä»¥ä¸‹é˜Ÿåˆ—ï¼š

| é˜Ÿåˆ—åç§° | è·¯ç”±é”® | ç”¨é€” |
|---------|--------|------|
| `secretflow_queue` | `secretflow` | SecretFlowè®¡ç®—ä»»åŠ¡ |
| `default` | `celery` | é»˜è®¤ä»»åŠ¡é˜Ÿåˆ— |
| `web_queue` | `web` | Webç›¸å…³ä»»åŠ¡ |

### **æŒ‡å®šé˜Ÿåˆ—å‘é€ä»»åŠ¡**
```python
# å‘é€åˆ°secretflow_queue
result = app.send_task(
    'tasks.secretflow.execute_task',
    args=[...],
    queue='secretflow_queue',
    routing_key='secretflow'
)

# å‘é€åˆ°defaulté˜Ÿåˆ—
result = app.send_task(
    'tasks.secretflow.hello.hello_task',
    queue='default',
    routing_key='celery'
)
```

---

## âš¡ å¿«é€Ÿå‚è€ƒ

### **å‘é€ä»»åŠ¡çš„æ­£ç¡®æ–¹å¼**
```bash
# âœ… æ­£ç¡®ï¼šä½¿ç”¨Makefile
make task-hello

# âœ… æ­£ç¡®ï¼šä½¿ç”¨Pythonè„šæœ¬
python scripts/send_task.py hello

# âœ… æ­£ç¡®ï¼šä½¿ç”¨Python API
python -c "from src.celery_app import app; app.send_task('tasks.secretflow.hello.hello_task', queue='secretflow_queue')"

# âœ… æ­£ç¡®ï¼šä½¿ç”¨celery send-task
celery -A src.celery_app send-task tasks.secretflow.hello.hello_task --queue=secretflow_queue
```

### **é”™è¯¯çš„æ–¹å¼ï¼ˆä¸ä¼šå‘é€åˆ°é˜Ÿåˆ—ï¼‰**
```bash
# âŒ é”™è¯¯ï¼šcelery call æ˜¯åŒæ­¥æ‰§è¡Œï¼Œä¸ä¼šå‘é€åˆ°é˜Ÿåˆ—
celery -A src.celery_app call tasks.secretflow.hello.hello_task

# âŒ é”™è¯¯ï¼šç›´æ¥å¯¼å…¥æ‰§è¡Œ
python -c "from tasks.secretflow.hello import hello_task; hello_task()"
```

---

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### **é—®é¢˜1ï¼šä»»åŠ¡ä¸€ç›´å¤„äºPENDINGçŠ¶æ€**
**åŸå› **ï¼šWorkeræ²¡æœ‰è¿è¡Œæˆ–æ²¡æœ‰ç›‘å¬è¯¥é˜Ÿåˆ—

**è§£å†³**ï¼š
```bash
# æ£€æŸ¥WorkerçŠ¶æ€
make docker-ps

# æŸ¥çœ‹Workeræ—¥å¿—
make docker-logs-worker

# ç¡®è®¤Workerç›‘å¬çš„é˜Ÿåˆ—
docker exec node1-worker celery -A src.celery_app inspect active_queues
```

### **é—®é¢˜2ï¼šä»»åŠ¡å‘é€å¤±è´¥**
**åŸå› **ï¼šRedisè¿æ¥é—®é¢˜

**è§£å†³**ï¼š
```bash
# æ£€æŸ¥RedisçŠ¶æ€
docker ps --filter name=redis

# æµ‹è¯•Redisè¿æ¥
docker exec node1-redis redis-cli ping

# æ£€æŸ¥ç¯å¢ƒå˜é‡
echo $REDIS_URL
```

### **é—®é¢˜3ï¼šä»»åŠ¡æ‰§è¡Œå¤±è´¥**
**åŸå› **ï¼šä»»åŠ¡å‚æ•°é”™è¯¯æˆ–ä»£ç bug

**è§£å†³**ï¼š
```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
make docker-logs-worker

# ä½¿ç”¨Pythonäº¤äº’å¼ç¯å¢ƒè°ƒè¯•
make task-send
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Celeryå®˜æ–¹æ–‡æ¡£ - Calling Tasks](https://docs.celeryq.dev/en/stable/userguide/calling.html)
- [SecretFlowå®˜æ–¹æ–‡æ¡£](https://www.secretflow.org.cn/docs/secretflow/)
- [é¡¹ç›®é…ç½®è¯´æ˜](./configuration_explanation.md)
- [Rayæ¶æ„è¯´æ˜](./ray_architecture_clarification.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2026-01-06
