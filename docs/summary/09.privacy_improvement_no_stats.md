# éšç§ä¿æŠ¤æ”¹è¿›ï¼šç§»é™¤é¢„æµ‹ç»Ÿè®¡ä¿¡æ¯

## æ”¹è¿›æ¦‚è¿°

**æ”¹è¿›æ—¥æœŸ**: 2026-01-05  
**æ”¹è¿›ç›®æ ‡**: ç§»é™¤é¢„æµ‹ç»“æœçš„ç»Ÿè®¡ä¿¡æ¯è¿”å›ï¼Œé¿å…æ³„éœ²æ•°æ®åˆ†å¸ƒ

## é—®é¢˜åˆ†æ

### åŸå®ç°çš„éšç§é£é™©

```python
# åŸä»£ç ï¼ˆå­˜åœ¨éšç§æ³„éœ²ï¼‰
def save_predictions(pred_data, output_file):
    ...
    # è¿”å›ç»Ÿè®¡ä¿¡æ¯
    return {
        'num_predictions': len(pred_flat),
        'mean': float(np.mean(pred_flat)),      # âŒ æ³„éœ²å‡å€¼
        'std': float(np.std(pred_flat)),        # âŒ æ³„éœ²æ ‡å‡†å·®
        'min': float(np.min(pred_flat)),        # âŒ æ³„éœ²æœ€å°å€¼
        'max': float(np.max(pred_flat))         # âŒ æ³„éœ²æœ€å¤§å€¼
    }

# è¿”å›ç»“æœ
result = {
    "output_path": output_path,
    "receiver_party": receiver_party,
    "num_predictions": stats['num_predictions'],
    "secure_mode": True,
    "statistics": {                              # âŒ å…¬å¼€ç»Ÿè®¡ä¿¡æ¯
        "mean": stats['mean'],
        "std": stats['std'],
        "min": stats['min'],
        "max": stats['max']
    }
}
```

### éšç§æ³„éœ²é£é™©

**æ³„éœ²çš„ä¿¡æ¯**:
- âŒ **å‡å€¼ï¼ˆmeanï¼‰**: æ­ç¤ºé¢„æµ‹ç»“æœçš„å¹³å‡æ°´å¹³
- âŒ **æ ‡å‡†å·®ï¼ˆstdï¼‰**: æ­ç¤ºæ•°æ®çš„ç¦»æ•£ç¨‹åº¦
- âŒ **æœ€å°å€¼ï¼ˆminï¼‰**: æ­ç¤ºæœ€ä½é¢„æµ‹å€¼
- âŒ **æœ€å¤§å€¼ï¼ˆmaxï¼‰**: æ­ç¤ºæœ€é«˜é¢„æµ‹å€¼

**æ½œåœ¨é£é™©**:
1. **æ•°æ®åˆ†å¸ƒæ¨æ–­**: é€šè¿‡ç»Ÿè®¡ä¿¡æ¯å¯ä»¥æ¨æ–­é¢„æµ‹æ•°æ®çš„åˆ†å¸ƒç‰¹å¾
2. **æ•æ„Ÿä¿¡æ¯æ³„éœ²**: åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œç»Ÿè®¡ä¿¡æ¯æœ¬èº«å°±æ˜¯æ•æ„Ÿä¿¡æ¯
3. **å·®åˆ†æ”»å‡»**: å¤šæ¬¡æŸ¥è¯¢ç»Ÿè®¡ä¿¡æ¯å¯èƒ½è¢«ç”¨äºå·®åˆ†æ”»å‡»
4. **è¿èƒŒéšç§ä¿æŠ¤åŸåˆ™**: é¢„æµ‹ç»“æœåº”è¯¥åªæœ‰æ¥æ”¶æ–¹çŸ¥é“

### ç¤ºä¾‹åœºæ™¯

**åŒ»ç–—é¢„æµ‹åœºæ™¯**:
```python
# é¢„æµ‹ç»“æœç»Ÿè®¡
{
    "mean": 0.85,      # å¹³å‡æ‚£ç—…æ¦‚ç‡85%
    "std": 0.12,       # æ ‡å‡†å·®12%
    "min": 0.45,       # æœ€ä½æ¦‚ç‡45%
    "max": 0.98        # æœ€é«˜æ¦‚ç‡98%
}
```

**é—®é¢˜**: å³ä½¿ä¸çŸ¥é“å…·ä½“ä¸ªäººçš„é¢„æµ‹ç»“æœï¼Œè¿™äº›ç»Ÿè®¡ä¿¡æ¯ä¹Ÿæ­ç¤ºäº†ï¼š
- æ•´ä½“æ‚£ç—…é£é™©å¾ˆé«˜ï¼ˆå‡å€¼85%ï¼‰
- å­˜åœ¨é«˜é£é™©ä¸ªä½“ï¼ˆæœ€å¤§å€¼98%ï¼‰
- æ•°æ®åˆ†å¸ƒç›¸å¯¹é›†ä¸­ï¼ˆæ ‡å‡†å·®12%ï¼‰

## æ”¹è¿›æ–¹æ¡ˆ

### æ”¹è¿›åçš„å®ç°

```python
# æ–°ä»£ç ï¼ˆéšç§ä¿æŠ¤ï¼‰
def save_predictions(pred_data, output_file):
    """åœ¨PYUä¸Šæ‰§è¡Œçš„ä¿å­˜å‡½æ•°"""
    import pandas as pd
    import numpy as np
    import os
    
    # åˆ›å»ºè¾“å‡ºç›®å½•
    output_dir = os.path.dirname(output_file)
    if output_dir and not os.path.exists(output_dir):
        os.makedirs(output_dir, exist_ok=True)
    
    # è½¬æ¢ä¸ºDataFrameå¹¶ä¿å­˜
    if isinstance(pred_data, np.ndarray):
        pred_flat = pred_data.flatten()
    else:
        pred_flat = pred_data
    
    pred_df = pd.DataFrame({
        'prediction': pred_flat,
        'probability': pred_flat
    })
    
    pred_df.to_csv(output_file, index=False)
    
    # åªè¿”å›é¢„æµ‹æ•°é‡ï¼ˆä¸æ³„éœ²æ•°æ®åˆ†å¸ƒä¿¡æ¯ï¼‰
    return len(pred_flat)

# åœ¨æ¥æ”¶æ–¹PYUä¸Šæ‰§è¡Œä¿å­˜æ“ä½œ
num_predictions_pyu = receiver_pyu(save_predictions)(predictions_pyu, output_path)

# åªè·å–é¢„æµ‹æ•°é‡ï¼ˆä¸revealç»Ÿè®¡ä¿¡æ¯ï¼‰
from secretflow.device import reveal
num_predictions = reveal(num_predictions_pyu)

# è¿”å›ç»“æœ
result = {
    "output_path": output_path,
    "receiver_party": receiver_party,
    "num_predictions": num_predictions,  # âœ… åªè¿”å›æ•°é‡
    "secure_mode": True                   # âœ… æ— ç»Ÿè®¡ä¿¡æ¯
}
```

### æ”¹è¿›è¦ç‚¹

1. **ç§»é™¤ç»Ÿè®¡è®¡ç®—**: ä¸è®¡ç®—å‡å€¼ã€æ ‡å‡†å·®ã€æœ€å°å€¼ã€æœ€å¤§å€¼
2. **åªè¿”å›æ•°é‡**: é¢„æµ‹æ•°é‡æ˜¯éæ•æ„Ÿä¿¡æ¯ï¼Œå¯ä»¥å…¬å¼€
3. **æ•°æ®ä¿ç•™åœ¨æ¥æ”¶æ–¹**: é¢„æµ‹ç»“æœåªä¿å­˜åœ¨æ¥æ”¶æ–¹çš„æ–‡ä»¶ç³»ç»Ÿä¸Š
4. **æ— é¢å¤–reveal**: é™¤äº†é¢„æµ‹æ•°é‡ï¼Œä¸revealä»»ä½•å…¶ä»–ä¿¡æ¯

## éšç§ä¿æŠ¤å¯¹æ¯”

### ä¿¡æ¯å…¬å¼€ç¨‹åº¦

| ä¿¡æ¯ç±»å‹ | æ”¹è¿›å‰ | æ”¹è¿›å | éšç§é£é™© |
|---------|-------|-------|---------|
| é¢„æµ‹æ•°é‡ | âœ… å…¬å¼€ | âœ… å…¬å¼€ | ä½ |
| å‡å€¼ | âŒ å…¬å¼€ | âœ… éšè— | é«˜ |
| æ ‡å‡†å·® | âŒ å…¬å¼€ | âœ… éšè— | é«˜ |
| æœ€å°å€¼ | âŒ å…¬å¼€ | âœ… éšè— | é«˜ |
| æœ€å¤§å€¼ | âŒ å…¬å¼€ | âœ… éšè— | é«˜ |
| åŸå§‹æ•°æ® | âœ… éšè— | âœ… éšè— | æé«˜ |

### æ•°æ®æµå‘

**æ”¹è¿›å‰**:
```
æ¥æ”¶æ–¹PYU
  â†’ è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
  â†’ revealåˆ°driver
  â†’ æ‰€æœ‰å‚ä¸æ–¹éƒ½èƒ½çœ‹åˆ°ç»Ÿè®¡ä¿¡æ¯ âŒ
```

**æ”¹è¿›å**:
```
æ¥æ”¶æ–¹PYU
  â†’ åªè®¡ç®—æ•°é‡
  â†’ revealåˆ°driver
  â†’ åªå…¬å¼€æ•°é‡ï¼Œä¸å…¬å¼€åˆ†å¸ƒä¿¡æ¯ âœ…
```

## æµ‹è¯•æ›´æ–°

### æµ‹è¯•ä¿®æ”¹

```python
# æ—§æµ‹è¯•
assert 'statistics' in result  # âŒ æ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯å­˜åœ¨

# æ–°æµ‹è¯•
assert 'statistics' not in result  # âœ… éªŒè¯ä¸è¿”å›ç»Ÿè®¡ä¿¡æ¯
```

### æµ‹è¯•ç»“æœ

```bash
pytest tests/unit/test_ml_task.py -v
```

**ç»“æœ**: âœ… 3/3 å…¨éƒ¨é€šè¿‡
- `test_secure_save_and_load` âœ…
- `test_secure_predict` âœ…
- `test_share_files_are_different` âœ…

## ä½¿ç”¨ç¤ºä¾‹

### æ‰§è¡Œé¢„æµ‹

```python
from secretflow_task.task_dispatcher import TaskDispatcher

# é¢„æµ‹é…ç½®
predict_config = {
    "model_path": "models/lr_model",
    "predict_data": {
        "alice": "test_alice.csv",
        "bob": "test_bob.csv"
    },
    "output_path": "results/predictions.csv",
    "receiver_party": "alice"
}

# æ‰§è¡Œé¢„æµ‹
result = TaskDispatcher.dispatch('ss_lr_predict', devices, predict_config)

# è¿”å›ç»“æœï¼ˆæ”¹è¿›åï¼‰
# {
#     "output_path": "results/predictions.csv",
#     "receiver_party": "alice",
#     "num_predictions": 1000,
#     "secure_mode": True
# }
```

### ç»“æœè¯´æ˜

**å…¬å¼€ä¿¡æ¯**:
- âœ… `output_path`: é¢„æµ‹ç»“æœæ–‡ä»¶è·¯å¾„
- âœ… `receiver_party`: æ¥æ”¶æ–¹åç§°
- âœ… `num_predictions`: é¢„æµ‹æ•°é‡
- âœ… `secure_mode`: å®‰å…¨æ¨¡å¼æ ‡å¿—

**éšè—ä¿¡æ¯**:
- âœ… é¢„æµ‹ç»“æœçš„å…·ä½“å€¼ï¼ˆåªåœ¨æ¥æ”¶æ–¹ï¼‰
- âœ… é¢„æµ‹ç»“æœçš„ç»Ÿè®¡åˆ†å¸ƒï¼ˆå‡å€¼ã€æ ‡å‡†å·®ç­‰ï¼‰
- âœ… é¢„æµ‹ç»“æœçš„æå€¼ï¼ˆæœ€å°å€¼ã€æœ€å¤§å€¼ï¼‰

## éšç§ä¿æŠ¤åŸåˆ™

### 1. æœ€å°åŒ–ä¿¡æ¯å…¬å¼€

**åŸåˆ™**: åªå…¬å¼€å®Œæˆä»»åŠ¡å¿…éœ€çš„æœ€å°‘ä¿¡æ¯

**å®è·µ**:
- âœ… é¢„æµ‹æ•°é‡ï¼šç”¨äºéªŒè¯ä»»åŠ¡å®Œæˆ
- âŒ ç»Ÿè®¡ä¿¡æ¯ï¼šéå¿…éœ€ï¼Œå¯èƒ½æ³„éœ²éšç§

### 2. æ•°æ®æœ¬åœ°åŒ–

**åŸåˆ™**: æ•æ„Ÿæ•°æ®åªåœ¨æˆæƒæ–¹æœ¬åœ°å¤„ç†å’Œå­˜å‚¨

**å®è·µ**:
- âœ… é¢„æµ‹ç»“æœåªä¿å­˜åœ¨æ¥æ”¶æ–¹
- âœ… åœ¨æ¥æ”¶æ–¹PYUä¸Šç›´æ¥ä¿å­˜æ–‡ä»¶
- âœ… ä¸ç»è¿‡driverä¸­è½¬

### 3. é¿å…ä¾§ä¿¡é“æ³„éœ²

**åŸåˆ™**: é˜²æ­¢é€šè¿‡ç»Ÿè®¡ä¿¡æ¯ç­‰ä¾§ä¿¡é“æ³„éœ²æ•°æ®

**å®è·µ**:
- âœ… ä¸è¿”å›ç»Ÿè®¡ä¿¡æ¯
- âœ… ä¸è¿”å›æ•°æ®åˆ†å¸ƒç‰¹å¾
- âœ… åªè¿”å›éæ•æ„Ÿçš„å…ƒä¿¡æ¯

## å®‰å…¨æ€§åˆ†æ

### æ”»å‡»åœºæ™¯åˆ†æ

#### åœºæ™¯1ï¼šç»Ÿè®¡æ¨æ–­æ”»å‡»

**æ”»å‡»æ–¹å¼**: é€šè¿‡å¤šæ¬¡æŸ¥è¯¢ç»Ÿè®¡ä¿¡æ¯æ¨æ–­ä¸ªä½“æ•°æ®

**æ”¹è¿›å‰**: âŒ å¯èƒ½æˆåŠŸ
- æ”»å‡»è€…å¯ä»¥è·å–å‡å€¼ã€æ ‡å‡†å·®ç­‰ç»Ÿè®¡ä¿¡æ¯
- é€šè¿‡å¤šæ¬¡æŸ¥è¯¢å¯èƒ½æ¨æ–­å‡ºä¸ªä½“æ•°æ®

**æ”¹è¿›å**: âœ… é˜²å¾¡æˆåŠŸ
- ä¸è¿”å›ä»»ä½•ç»Ÿè®¡ä¿¡æ¯
- æ”»å‡»è€…æ— æ³•è·å–æ•°æ®åˆ†å¸ƒ

#### åœºæ™¯2ï¼šå·®åˆ†æ”»å‡»

**æ”»å‡»æ–¹å¼**: é€šè¿‡å¯¹æ¯”æœ‰æ— æŸä¸ªæ ·æœ¬çš„ç»Ÿè®¡å·®å¼‚æ¨æ–­è¯¥æ ·æœ¬ä¿¡æ¯

**æ”¹è¿›å‰**: âŒ å¯èƒ½æˆåŠŸ
- å¯ä»¥å¯¹æ¯”ç»Ÿè®¡ä¿¡æ¯çš„å˜åŒ–
- å¯èƒ½æ¨æ–­å‡ºä¸ªä½“æ ·æœ¬çš„å½±å“

**æ”¹è¿›å**: âœ… é˜²å¾¡æˆåŠŸ
- æ— ç»Ÿè®¡ä¿¡æ¯å¯ä¾›å¯¹æ¯”
- æ— æ³•è¿›è¡Œå·®åˆ†æ”»å‡»

#### åœºæ™¯3ï¼šåˆ†å¸ƒæ¨æ–­æ”»å‡»

**æ”»å‡»æ–¹å¼**: é€šè¿‡ç»Ÿè®¡ä¿¡æ¯æ¨æ–­æ•°æ®æ•´ä½“åˆ†å¸ƒ

**æ”¹è¿›å‰**: âŒ å¯èƒ½æˆåŠŸ
- å‡å€¼ã€æ ‡å‡†å·®ã€æå€¼å¯ä»¥æè¿°åˆ†å¸ƒ
- å¯ä»¥æ¨æ–­æ•°æ®çš„å¤§è‡´åˆ†å¸ƒ

**æ”¹è¿›å**: âœ… é˜²å¾¡æˆåŠŸ
- åªçŸ¥é“æ•°æ®é‡
- æ— æ³•æ¨æ–­åˆ†å¸ƒç‰¹å¾

## æ€§èƒ½å½±å“

### è®¡ç®—å¼€é”€

**æ”¹è¿›å‰**:
```python
# è®¡ç®—5ä¸ªç»Ÿè®¡é‡
num = len(pred_flat)
mean = np.mean(pred_flat)
std = np.std(pred_flat)
min_val = np.min(pred_flat)
max_val = np.max(pred_flat)
```

**æ”¹è¿›å**:
```python
# åªè®¡ç®—1ä¸ªç»Ÿè®¡é‡
num = len(pred_flat)
```

**æ€§èƒ½æå‡**: å‡å°‘äº†4æ¬¡ç»Ÿè®¡è®¡ç®—ï¼Œæ€§èƒ½ç•¥æœ‰æå‡

### é€šä¿¡å¼€é”€

**æ”¹è¿›å‰**: reveal 5ä¸ªæ•°å€¼ï¼ˆnum, mean, std, min, maxï¼‰  
**æ”¹è¿›å**: reveal 1ä¸ªæ•°å€¼ï¼ˆnumï¼‰

**é€šä¿¡ä¼˜åŒ–**: å‡å°‘äº†80%çš„revealæ•°æ®é‡

## æœ€ä½³å®è·µå»ºè®®

### 1. ä¸¥æ ¼æ§åˆ¶ä¿¡æ¯å…¬å¼€

```python
# âŒ ä¸å¥½çš„åšæ³•
return {
    'data': predictions,           # æ³„éœ²åŸå§‹æ•°æ®
    'mean': np.mean(predictions),  # æ³„éœ²ç»Ÿè®¡ä¿¡æ¯
    'std': np.std(predictions)
}

# âœ… å¥½çš„åšæ³•
return {
    'num_predictions': len(predictions)  # åªè¿”å›éæ•æ„Ÿä¿¡æ¯
}
```

### 2. æ•°æ®æœ¬åœ°å¤„ç†

```python
# âŒ ä¸å¥½çš„åšæ³•
predictions = reveal(predictions_pyu)  # å…¬å¼€ç»™æ‰€æœ‰äºº
save_locally(predictions)

# âœ… å¥½çš„åšæ³•
receiver_pyu(save_locally)(predictions_pyu)  # åªåœ¨æ¥æ”¶æ–¹å¤„ç†
```

### 3. æœ€å°åŒ–reveal

```python
# âŒ ä¸å¥½çš„åšæ³•
stats = reveal(compute_all_stats(data))  # revealæ‰€æœ‰ç»Ÿè®¡ä¿¡æ¯

# âœ… å¥½çš„åšæ³•
count = reveal(compute_count(data))  # åªrevealå¿…è¦ä¿¡æ¯
```

## æ€»ç»“

### æ”¹è¿›æˆæœ

1. âœ… **ç§»é™¤ç»Ÿè®¡ä¿¡æ¯è¿”å›**: ä¸å†å…¬å¼€å‡å€¼ã€æ ‡å‡†å·®ã€æå€¼
2. âœ… **åªè¿”å›é¢„æµ‹æ•°é‡**: æœ€å°åŒ–ä¿¡æ¯å…¬å¼€
3. âœ… **æå‡éšç§ä¿æŠ¤**: é˜²æ­¢ç»Ÿè®¡æ¨æ–­ã€å·®åˆ†æ”»å‡»ç­‰
4. âœ… **æµ‹è¯•å…¨éƒ¨é€šè¿‡**: åŠŸèƒ½æ­£å¸¸ï¼Œéšç§å¢å¼º

### éšç§ä¿æŠ¤çº§åˆ«

**æ”¹è¿›å‰**: ä¸­ç­‰
- âœ… é¢„æµ‹ç»“æœåªå‘é€ç»™æ¥æ”¶æ–¹
- âŒ ç»Ÿè®¡ä¿¡æ¯å…¬å¼€ç»™æ‰€æœ‰äºº

**æ”¹è¿›å**: é«˜
- âœ… é¢„æµ‹ç»“æœåªå‘é€ç»™æ¥æ”¶æ–¹
- âœ… ç»Ÿè®¡ä¿¡æ¯ä¸å…¬å¼€
- âœ… åªå…¬å¼€éæ•æ„Ÿçš„é¢„æµ‹æ•°é‡

### é€‚ç”¨åœºæ™¯

**å¼ºéšç§ä¿æŠ¤åœºæ™¯**:
- âœ… åŒ»ç–—æ•°æ®é¢„æµ‹
- âœ… é‡‘èé£é™©è¯„ä¼°
- âœ… ä¸ªäººä¿¡ç”¨è¯„åˆ†
- âœ… ä»»ä½•éœ€è¦ä¸¥æ ¼éšç§ä¿æŠ¤çš„åœºæ™¯

**è¿™æ˜¯SecretFlowéšç§è®¡ç®—çš„æœ€ä½³å®è·µï¼** ğŸ”’
