# SecretFlowç”Ÿäº§éƒ¨ç½²é—®é¢˜æ€»ç»“ä¸è§£å†³æ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ—¨åœ¨å®ç°SecretFlowéšç§è®¡ç®—æ¡†æ¶çš„ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼Œä½¿ç”¨Docker Compose + Hostç½‘ç»œæ¨¡å¼ï¼Œæ¯ä¸ªèŠ‚ç‚¹è¿è¡Œç‹¬ç«‹çš„Rayé›†ç¾¤å’ŒCelery Workerã€‚

**æŠ€æœ¯æ ˆ**ï¼š
- SecretFlow 1.12.0b0
- Python 3.10.16
- Ray 2.42.0
- Celery 5.6.1
- Redis 7.4.7
- Docker + Docker Compose

---

## ğŸ” æ ¸å¿ƒé—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šRay CLIåœ¨Python 3.10ä¸‹çš„å…¼å®¹æ€§é—®é¢˜

#### **é—®é¢˜æè¿°**
ä½¿ç”¨`ray start`å‘½ä»¤å¯åŠ¨Rayé›†ç¾¤æ—¶ï¼Œå‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š
```
ValueError: <object object at 0x7c8423c7b460> is not a valid Sentinel
```

#### **é”™è¯¯å †æ ˆ**
```python
File "/usr/local/lib/python3.10/site-packages/ray/scripts/scripts.py", line 2620
    new_command = copy.deepcopy(command)
File "/usr/local/lib/python3.10/copy.py", line 172, in deepcopy
    y = _reconstruct(x, memo, *rv)
File "/usr/local/lib/python3.10/enum.py", line 710, in __new__
    raise ve_exc
ValueError: <object object at 0x...> is not a valid Sentinel
```

#### **æ ¹æœ¬åŸå› **
- Ray 2.42.0çš„CLIå·¥å…·ä¾èµ–`click`åº“è¿›è¡Œå‘½ä»¤è¡Œè§£æ
- `click>=8.1.0`ç‰ˆæœ¬åœ¨Python 3.10ç¯å¢ƒä¸‹ï¼Œä¸Ray CLIä½¿ç”¨çš„`enum.Enum`å®ç°å­˜åœ¨å…¼å®¹æ€§å†²çª
- å…·ä½“è¡¨ç°ä¸º`copy.deepcopy()`åœ¨å¤„ç†clickå‘½ä»¤å¯¹è±¡æ—¶ï¼Œæ— æ³•æ­£ç¡®åºåˆ—åŒ–`Sentinel`æšä¸¾å€¼

#### **è§£å†³æ–¹æ¡ˆ** âœ…
åœ¨`pyproject.toml`ä¸­æ·»åŠ clickç‰ˆæœ¬é™åˆ¶ï¼š
```toml
dependencies = [
    "secretflow==1.12.0b0",
    # ... å…¶ä»–ä¾èµ–
    "click>=8.0.0,<8.1.0",  # å…³é”®ï¼šé™åˆ¶clickç‰ˆæœ¬
]
```

**ç»“æœ**ï¼š
- clickç‰ˆæœ¬é™çº§åˆ°`8.0.4`
- `ray start`å‘½ä»¤å¯ä»¥æ­£å¸¸å·¥ä½œ
- Ray GCSç«¯å£å¯ä»¥é€šè¿‡`--port`å‚æ•°å›ºå®š

---

### é—®é¢˜2ï¼šRedisè¿æ¥éªŒè¯é€»è¾‘é”™è¯¯

#### **é—®é¢˜æè¿°**
Celeryé…ç½®éªŒè¯æ—¶æŠ¥é”™ï¼š
```
ValueError: ç”Ÿäº§ç¯å¢ƒä¸åº”ä½¿ç”¨localhostçš„Redisè¿æ¥
```

#### **åŸå› åˆ†æ**
åˆå§‹éªŒè¯é€»è¾‘è¿‡äºä¸¥æ ¼ï¼š
```python
# é”™è¯¯çš„éªŒè¯é€»è¾‘
if "localhost" in self.broker_url:
    raise ValueError("ç”Ÿäº§ç¯å¢ƒä¸åº”ä½¿ç”¨localhost")
```

è¿™å¯¼è‡´å³ä½¿ä½¿ç”¨`redis://127.0.0.1:60379/0`ä¹Ÿä¼šè¢«è¯¯åˆ¤ï¼Œå› ä¸ºå­—ç¬¦ä¸²åŒ…å«"localhost"å­ä¸²ã€‚

#### **è§£å†³æ–¹æ¡ˆ** âœ…
ä¿®æ”¹éªŒè¯é€»è¾‘ï¼Œæ˜ç¡®åŒºåˆ†`localhost`å­—ç¬¦ä¸²å’Œ`127.0.0.1`ï¼š
```python
# æ­£ç¡®çš„éªŒè¯é€»è¾‘
if "localhost" in self.broker_url and "127.0.0.1" not in self.broker_url:
    raise ValueError("ç”Ÿäº§ç¯å¢ƒè¯·ä½¿ç”¨127.0.0.1è€Œélocalhost")
```

**é…ç½®æ ¼å¼**ï¼š
```bash
# .env.production
REDIS_URL=redis://127.0.0.1:60379/0  # âœ… æ­£ç¡®
# REDIS_URL=redis://localhost:60379/0  # âŒ é”™è¯¯
```

---

### é—®é¢˜3ï¼šRayé›†ç¾¤æ¶æ„ç†è§£åå·®

#### **åˆå§‹è¯¯è§£**
æœ€åˆè®¤ä¸ºéœ€è¦é…ç½®Ray workerèŠ‚ç‚¹è¿æ¥åˆ°headèŠ‚ç‚¹ï¼Œç±»ä¼¼ä¼ ç»Ÿåˆ†å¸ƒå¼é›†ç¾¤ï¼š
```
é”™è¯¯æ¶æ„ï¼š
Node1: Ray Head
Node2: Ray Worker -> è¿æ¥åˆ°Node1
```

#### **æ­£ç¡®ç†è§£** âœ…
æ ¹æ®SecretFlowå®˜æ–¹æ–‡æ¡£å’Œä»£ç åˆ†æï¼Œç”Ÿäº§æ¨¡å¼ä¸‹ï¼š
- **æ¯ä¸ªèŠ‚ç‚¹éƒ½è¿è¡Œç‹¬ç«‹çš„Rayå¤´èŠ‚ç‚¹**
- **ä¸éœ€è¦Ray workerèŠ‚ç‚¹**
- **èŠ‚ç‚¹é—´é€šè¿‡SecretFlowçš„`cluster_config`é€šä¿¡ï¼Œè€ŒéRayé›†ç¾¤**

**æ­£ç¡®æ¶æ„**ï¼š
```
Node1: ç‹¬ç«‹Rayé›†ç¾¤ + Celery Worker
Node2: ç‹¬ç«‹Rayé›†ç¾¤ + Celery Worker
       â†“
é€šè¿‡SecretFlowçš„cluster_configè¿›è¡Œè·¨èŠ‚ç‚¹é€šä¿¡
```

#### **æ¶æ„å¯¹æ¯”**

| ç‰¹æ€§ | ä»¿çœŸæ¨¡å¼ | ç”Ÿäº§æ¨¡å¼ï¼ˆæ­£ç¡®ï¼‰ |
|------|---------|-----------------|
| Rayé›†ç¾¤ | å•ä¸ªå…±äº«é›†ç¾¤ | æ¯ä¸ªèŠ‚ç‚¹ç‹¬ç«‹é›†ç¾¤ |
| Rayè¿æ¥ | Workerè¿æ¥Head | å„è‡ªç‹¬ç«‹ï¼Œä¸è¿æ¥ |
| ä»£ç æ‰§è¡Œ | æ‰§è¡Œä¸€æ¬¡ | æ¯ä¸ªèŠ‚ç‚¹éƒ½æ‰§è¡Œ |
| èŠ‚ç‚¹é€šä¿¡ | Rayå†…éƒ¨ | SecretFlow cluster_config |
| é€‚ç”¨åœºæ™¯ | å¼€å‘æµ‹è¯• | ç”Ÿäº§éƒ¨ç½² |

#### **é…ç½®ç®€åŒ–**
ç§»é™¤äº†ä¸å¿…è¦çš„é…ç½®é¡¹ï¼š
```bash
# ç§»é™¤çš„é…ç½®
# RAY_NODE_TYPE=head/worker  # ä¸å†éœ€è¦
# RAY_HEAD_ADDRESS=...       # ä¸å†éœ€è¦

# ä¿ç•™çš„é…ç½®
NODE_ID=node1
NODE_IP=***.***.***.***
RAY_PORT=61379
RAY_NUM_CPUS=0
RAY_OBJECT_STORE_MEMORY=2000000000
```

---

### é—®é¢˜4ï¼šDocker Compose Rediså‘½ä»¤æ ¼å¼é”™è¯¯

#### **é—®é¢˜æè¿°**
Rediså®¹å™¨å¯åŠ¨å¤±è´¥ï¼Œæ—¥å¿—æ˜¾ç¤ºï¼š
```
FATAL CONFIG FILE ERROR
*** Reading the configuration file, at line 2
>>> 'port "--maxmemory" "2gb"'
wrong number of arguments
```

#### **åŸå› åˆ†æ**
ä½¿ç”¨YAMLå¤šè¡Œå­—ç¬¦ä¸²æ ¼å¼å¯¼è‡´å‚æ•°è§£æé”™è¯¯ï¼š
```yaml
# é”™è¯¯æ ¼å¼
command: >
  redis-server
  --port ${REDIS_PORT}
  --maxmemory 2gb
```
è¿™ä¼šè¢«è§£æä¸ºå•ä¸ªå­—ç¬¦ä¸²ï¼Œå¯¼è‡´redis-serveræ— æ³•æ­£ç¡®è¯†åˆ«å‚æ•°ã€‚

#### **è§£å†³æ–¹æ¡ˆ** âœ…
ä½¿ç”¨YAMLæ•°ç»„æ ¼å¼ï¼š
```yaml
# æ­£ç¡®æ ¼å¼
command:
  - redis-server
  - --port
  - "60379"
  - --maxmemory
  - "2gb"
  - --maxmemory-policy
  - allkeys-lru
  - --appendonly
  - "yes"
  - --appendfsync
  - everysec
```

---

## ğŸ¯ æœ€ç»ˆéƒ¨ç½²æ¶æ„

### å•èŠ‚ç‚¹éƒ¨ç½²ç»“æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Node1 (***.***.***.***)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Redis (127.0.0.1:60379)            â”‚
â”‚    â†“                                â”‚
â”‚  Ray Head (***.***.***.***:61379)    â”‚
â”‚    â†“                                â”‚
â”‚  Celery Worker (2 workers)          â”‚
â”‚    - secretflow_queue               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¤šèŠ‚ç‚¹éƒ¨ç½²ç»“æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Node1               â”‚     â”‚  Node2               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Redis (60379)       â”‚     â”‚  Redis (60379)       â”‚
â”‚  Ray Head (61379)    â”‚     â”‚  Ray Head (61379)    â”‚
â”‚  Celery Worker       â”‚     â”‚  Celery Worker       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                            â†“
         â””â”€â”€â”€â”€ SecretFlowé€šä¿¡å±‚ â”€â”€â”€â”€â”€â”€â”˜
              (cluster_config)
```

---

## ğŸ“ å…³é”®é…ç½®æ–‡ä»¶

### 1. pyproject.toml
```toml
[project]
requires-python = "==3.10.16"
dependencies = [
    "secretflow==1.12.0b0",
    "celery[redis]",
    "click>=8.0.0,<8.1.0",  # å…³é”®é…ç½®
    # ... å…¶ä»–ä¾èµ–
]
```

### 2. .env.production
```bash
# èŠ‚ç‚¹é…ç½®
NODE_ID=node1
NODE_IP=***.***.***.***

# Redisé…ç½®
REDIS_URL=redis://127.0.0.1:60379/0

# Rayé…ç½®
RAY_PORT=61379
RAY_NUM_CPUS=0
RAY_OBJECT_STORE_MEMORY=2000000000

# Celeryé…ç½®
CELERY_WORKER_CONCURRENCY=2
CELERY_WORKER_MAX_TASKS_PER_CHILD=1000
```

### 3. entrypoint.sh
```bash
#!/bin/bash
set -e

echo "ğŸš€ å¯åŠ¨SecretFlow Workerå®¹å™¨..."
echo "ğŸ“‹ èŠ‚ç‚¹ID: ${NODE_ID}"
echo "ğŸ“‹ èŠ‚ç‚¹IP: ${NODE_IP}"

# å¯åŠ¨Rayé›†ç¾¤
echo "ğŸš€ å¯åŠ¨Rayé›†ç¾¤..."
ray start --head \
    --node-ip-address="${NODE_IP}" \
    --port="${RAY_PORT:-61379}" \
    --num-cpus="${RAY_NUM_CPUS:-0}" \
    --object-store-memory="${RAY_OBJECT_STORE_MEMORY:-2000000000}" \
    --include-dashboard=False \
    --disable-usage-stats

if [ $? -ne 0 ]; then
    echo "âŒ Rayå¯åŠ¨å¤±è´¥"
    exit 1
fi

echo "â³ ç­‰å¾…Rayåˆå§‹åŒ–..."
sleep 5

echo "ğŸ“Š æ£€æŸ¥RayçŠ¶æ€..."
ray status || echo "âš ï¸  ray statuså‘½ä»¤å¤±è´¥ï¼Œä½†Rayå¯èƒ½å·²æ­£å¸¸å¯åŠ¨"

echo "âœ… Rayå¯åŠ¨æˆåŠŸ"

# å¯åŠ¨Celery Worker
echo "ğŸš€ å¯åŠ¨Celery Worker..."
exec python src/worker.py
```

---

## âœ… éªŒè¯æ¸…å•

### éƒ¨ç½²éªŒè¯æ­¥éª¤
```bash
# 1. æ„å»ºé•œåƒ
docker build -f docker/Dockerfile -t secretflow-worker:latest .

# 2. å¯åŠ¨æœåŠ¡
docker compose -f docker/docker-compose.production.yml --env-file .env.production up -d

# 3. æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps --filter name=node1

# 4. éªŒè¯RayçŠ¶æ€
docker exec node1-worker ray status

# 5. æŸ¥çœ‹Workeræ—¥å¿—
docker logs node1-worker --tail 50

# 6. æ£€æŸ¥è¿›ç¨‹
docker exec node1-worker ps aux | grep -E "ray|celery"
```

### é¢„æœŸç»“æœ
```
âœ… å®¹å™¨çŠ¶æ€: Up X minutes (healthy)
âœ… RayçŠ¶æ€: Active (1 node)
âœ… Ray GCSç«¯å£: 61379
âœ… Celery Worker: node1@***.***.***.*** ready
âœ… é˜Ÿåˆ—é…ç½®: secretflow_queue
```

---

## ğŸ”§ æ•…éšœæ’æŸ¥æŒ‡å—

### é—®é¢˜ï¼šRayå¯åŠ¨å¤±è´¥
**æ£€æŸ¥**ï¼š
```bash
# æŸ¥çœ‹Rayæ—¥å¿—
docker exec node1-worker cat /tmp/ray/session_*/logs/gcs_server.out

# æ£€æŸ¥clickç‰ˆæœ¬
docker exec node1-worker pip show click
```

**è§£å†³**ï¼šç¡®ä¿clickç‰ˆæœ¬ä¸º8.0.x

### é—®é¢˜ï¼šCeleryè¿æ¥Rediså¤±è´¥
**æ£€æŸ¥**ï¼š
```bash
# æµ‹è¯•Redisè¿æ¥
docker exec node1-worker redis-cli -h 127.0.0.1 -p 60379 ping

# æ£€æŸ¥ç¯å¢ƒå˜é‡
docker exec node1-worker env | grep REDIS
```

**è§£å†³**ï¼šç¡®ä¿REDIS_URLä½¿ç”¨127.0.0.1è€Œélocalhost

### é—®é¢˜ï¼šå®¹å™¨å¥åº·æ£€æŸ¥å¤±è´¥
**æ£€æŸ¥**ï¼š
```bash
# æŸ¥çœ‹å¥åº·æ£€æŸ¥æ—¥å¿—
docker inspect node1-worker | jq '.[0].State.Health'

# æ‰‹åŠ¨æ‰§è¡Œå¥åº·æ£€æŸ¥å‘½ä»¤
docker exec node1-worker pgrep -f "celery worker"
docker exec node1-worker pgrep -f "ray::IDLE"
```

---

## ğŸ“š å‚è€ƒèµ„æº

### å®˜æ–¹æ–‡æ¡£
- [SecretFlowå®˜æ–¹æ–‡æ¡£](https://www.secretflow.org.cn/docs/secretflow/)
- [SecretFlow GitHub](https://github.com/secretflow/secretflow)
- [Rayæ–‡æ¡£](https://docs.ray.io/)
- [Celeryæ–‡æ¡£](https://docs.celeryq.dev/)

### å…³é”®å‘ç°
1. **SecretFlowä»¿çœŸæ¨¡å¼ vs ç”Ÿäº§æ¨¡å¼**ï¼š
   - ä»¿çœŸæ¨¡å¼ï¼šå•Rayé›†ç¾¤ï¼Œç”¨äºå¼€å‘æµ‹è¯•
   - ç”Ÿäº§æ¨¡å¼ï¼šç‹¬ç«‹Rayé›†ç¾¤ï¼Œç”¨äºçœŸå®éƒ¨ç½²

2. **Python 3.10å…¼å®¹æ€§**ï¼š
   - Ray CLIéœ€è¦click<8.1.0
   - è¿™æ˜¯Ray 2.42.0åœ¨Python 3.10ä¸‹çš„å·²çŸ¥é™åˆ¶

3. **Hostç½‘ç»œæ¨¡å¼ä¼˜åŠ¿**ï¼š
   - ç®€åŒ–ç½‘ç»œé…ç½®
   - é¿å…ç«¯å£æ˜ å°„å¤æ‚æ€§
   - é€‚åˆRayå¤šç«¯å£é€šä¿¡

---

## ğŸ“ ç»éªŒæ€»ç»“

### æˆåŠŸè¦ç´ 
1. âœ… **å‡†ç¡®çš„ä¾èµ–ç‰ˆæœ¬æ§åˆ¶**ï¼šclickç‰ˆæœ¬é™åˆ¶æ˜¯å…³é”®
2. âœ… **æ­£ç¡®çš„æ¶æ„ç†è§£**ï¼šæ¯ä¸ªèŠ‚ç‚¹ç‹¬ç«‹Rayé›†ç¾¤
3. âœ… **åˆç†çš„é…ç½®éªŒè¯**ï¼šåŒºåˆ†localhostå’Œ127.0.0.1
4. âœ… **å®Œå–„çš„å¥åº·æ£€æŸ¥**ï¼šè¿›ç¨‹çº§åˆ«è€Œéå‘½ä»¤çº§åˆ«

### é¿å…çš„é™·é˜±
1. âŒ ä¸è¦æ··æ·†ä»¿çœŸæ¨¡å¼å’Œç”Ÿäº§æ¨¡å¼çš„æ¶æ„
2. âŒ ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨localhostå­—ç¬¦ä¸²
3. âŒ ä¸è¦å¿½ç•¥clickç‰ˆæœ¬å¯¹Ray CLIçš„å½±å“
4. âŒ ä¸è¦ä½¿ç”¨YAMLå¤šè¡Œå­—ç¬¦ä¸²æ ¼å¼é…ç½®å‘½ä»¤å‚æ•°

### æœ€ä½³å®è·µ
1. ğŸ“Œ ä½¿ç”¨ç‰ˆæœ¬é”å®šç¡®ä¿ä¾èµ–ç¨³å®šæ€§
2. ğŸ“Œ ä½¿ç”¨Hostç½‘ç»œæ¨¡å¼ç®€åŒ–Rayéƒ¨ç½²
3. ğŸ“Œ ä½¿ç”¨è¿›ç¨‹æ£€æŸ¥è€Œéå‘½ä»¤æ£€æŸ¥è¿›è¡Œå¥åº·ç›‘æ§
4. ğŸ“Œ ä¿æŒé…ç½®æ–‡ä»¶çš„æ¸…æ™°å’Œæ–‡æ¡£åŒ–

---

## ğŸ“… æ›´æ–°æ—¥å¿—

**2026-01-06**
- å‘ç°å¹¶è§£å†³clickç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜
- æ¾„æ¸…SecretFlowç”Ÿäº§æ¨¡å¼æ¶æ„
- ç®€åŒ–Rayé›†ç¾¤é…ç½®
- ä¿®å¤Rediså‘½ä»¤æ ¼å¼é”™è¯¯
- å®Œæˆå•èŠ‚ç‚¹ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²éªŒè¯

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2026-01-06  
**ç»´æŠ¤è€…**: SecretFlowéƒ¨ç½²å›¢é˜Ÿ
