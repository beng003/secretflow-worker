# Statså’ŒEvaluationä»»åŠ¡æ¨¡å—é‡æ„æ€»ç»“

## é‡æ„æ¦‚è¿°

**å®Œæˆæ—¥æœŸ**: 2026-01-05  
**ç›®æ ‡**: é‡æ„ç»Ÿè®¡åˆ†æå’Œæ¨¡å‹è¯„ä¼°ä»»åŠ¡æ¨¡å—ï¼Œå‚è€ƒSecretFlowçš„statsæ¨¡å—ï¼Œåˆ›å»ºæ›´æ¸…æ™°çš„ç›®å½•ç»“æ„

## é‡æ„åŠ¨æœº

### åŸæœ‰é—®é¢˜

1. **åŠŸèƒ½ç¼ºå¤±**: stats_task.pyä»…æœ‰æ¨¡å—æ³¨é‡Šï¼Œæœªå®ç°ä»»ä½•åŠŸèƒ½
2. **ç¼ºä¹ç»„ç»‡**: ç»Ÿè®¡åˆ†æå’Œæ¨¡å‹è¯„ä¼°ä»»åŠ¡æ··åœ¨ä¸€èµ·
3. **ä¸ç¬¦åˆSecretFlowé£æ ¼**: ä¸SecretFlowçš„æ¨¡å—ç»„ç»‡æ–¹å¼ä¸ä¸€è‡´

### è§£å†³æ–¹æ¡ˆ

å‚è€ƒSecretFlowçš„`stats`æ¨¡å—ç»“æ„ï¼Œåˆ›å»ºç‹¬ç«‹çš„statså’Œevaluationå­æ¨¡å—ï¼š
- **stats**: ç»Ÿè®¡åˆ†æä»»åŠ¡ï¼ˆè¡¨ç»Ÿè®¡ã€ç›¸å…³æ€§åˆ†æã€VIFï¼‰
- **evaluation**: æ¨¡å‹è¯„ä¼°ä»»åŠ¡ï¼ˆäºŒåˆ†ç±»è¯„ä¼°ã€å›å½’è¯„ä¼°ï¼‰

## æ–°çš„ç›®å½•ç»“æ„

```
src/secretflow_task/jobs/
â”œâ”€â”€ stats/                               # ç»Ÿè®¡åˆ†æå­æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ table_statistics_task.py         # è¡¨ç»Ÿè®¡åˆ†æ
â”‚   â”œâ”€â”€ pearson_correlation_task.py      # Pearsonç›¸å…³æ€§åˆ†æ
â”‚   â””â”€â”€ vif_task.py                      # æ–¹å·®è†¨èƒ€å› å­
â””â”€â”€ evaluation/                          # æ¨¡å‹è¯„ä¼°å­æ¨¡å—
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ biclassification_eval_task.py    # äºŒåˆ†ç±»è¯„ä¼°
    â””â”€â”€ regression_eval_task.py          # å›å½’è¯„ä¼°
```

## å®ç°çš„ä»»åŠ¡

### 1. Statsç»Ÿè®¡åˆ†æå­æ¨¡å—

#### TableStatisticsï¼ˆè¡¨ç»Ÿè®¡åˆ†æï¼‰
- **æ–‡ä»¶**: `stats/table_statistics_task.py`
- **ä»»åŠ¡ç±»å‹**: `table_statistics`
- **åŠŸèƒ½**: è®¡ç®—è¡¨çš„ç»Ÿè®¡ä¿¡æ¯ï¼ˆæ•°æ®ç±»å‹ã€è®¡æ•°ã€ç¼ºå¤±å€¼ã€æœ€å°å€¼ã€æœ€å¤§å€¼ã€å‡å€¼ã€æ–¹å·®ã€æ ‡å‡†å·®ã€ååº¦ã€å³°åº¦ã€åˆ†ä½æ•°ç­‰ï¼‰
- **SecretFlow API**: `secretflow.stats.table_statistics`
- **å‚æ•°**:
  - `input_data`: è¾“å…¥æ•°æ®è·¯å¾„å­—å…¸
  - `columns`: éœ€è¦ç»Ÿè®¡çš„åˆ—ååˆ—è¡¨ï¼ˆå¯é€‰ï¼‰
  - `output_report`: ç»Ÿè®¡æŠ¥å‘Šè¾“å‡ºè·¯å¾„ï¼ˆJSONæ ¼å¼ï¼‰

#### PearsonCorrelationï¼ˆPearsonç›¸å…³æ€§åˆ†æï¼‰
- **æ–‡ä»¶**: `stats/pearson_correlation_task.py`
- **ä»»åŠ¡ç±»å‹**: `pearson_correlation`
- **åŠŸèƒ½**: è®¡ç®—å‚ç›´åˆ†åŒºæ•°æ®çš„Pearsonç›¸å…³ç³»æ•°çŸ©é˜µ
- **SecretFlow API**: `secretflow.stats.SSVertPearsonR`
- **å‚æ•°**:
  - `input_data`: è¾“å…¥æ•°æ®è·¯å¾„å­—å…¸
  - `columns`: éœ€è¦è®¡ç®—ç›¸å…³æ€§çš„åˆ—ååˆ—è¡¨
  - `output_report`: ç›¸å…³æ€§çŸ©é˜µè¾“å‡ºè·¯å¾„ï¼ˆJSONæ ¼å¼ï¼‰

#### VIFï¼ˆæ–¹å·®è†¨èƒ€å› å­ï¼‰
- **æ–‡ä»¶**: `stats/vif_task.py`
- **ä»»åŠ¡ç±»å‹**: `vif`
- **åŠŸèƒ½**: è®¡ç®—æ–¹å·®è†¨èƒ€å› å­ï¼Œæ£€æµ‹å¤šé‡å…±çº¿æ€§ï¼ˆVIF > 10è¡¨ç¤ºä¸¥é‡å…±çº¿æ€§ï¼‰
- **SecretFlow API**: `secretflow.stats.SSVertVIF`
- **å‚æ•°**:
  - `input_data`: è¾“å…¥æ•°æ®è·¯å¾„å­—å…¸
  - `columns`: éœ€è¦è®¡ç®—VIFçš„åˆ—ååˆ—è¡¨
  - `output_report`: VIFç»“æœè¾“å‡ºè·¯å¾„ï¼ˆJSONæ ¼å¼ï¼‰

### 2. Evaluationæ¨¡å‹è¯„ä¼°å­æ¨¡å—

#### BiClassificationEvalï¼ˆäºŒåˆ†ç±»è¯„ä¼°ï¼‰
- **æ–‡ä»¶**: `evaluation/biclassification_eval_task.py`
- **ä»»åŠ¡ç±»å‹**: `biclassification_eval`
- **åŠŸèƒ½**: è®¡ç®—äºŒåˆ†ç±»æ¨¡å‹çš„è¯„ä¼°æŒ‡æ ‡
- **SecretFlow API**: `secretflow.stats.BiClassificationEval`
- **è¯„ä¼°æŒ‡æ ‡**:
  - AUCï¼ˆArea Under Curveï¼‰
  - KSï¼ˆKolmogorov-Smirnovï¼‰
  - F1 Score
  - Precisionï¼ˆç²¾ç¡®ç‡ï¼‰
  - Recallï¼ˆå¬å›ç‡ï¼‰
  - Accuracyï¼ˆå‡†ç¡®ç‡ï¼‰
  - Confusion Matrixï¼ˆæ··æ·†çŸ©é˜µï¼‰
- **å‚æ•°**:
  - `prediction_data`: é¢„æµ‹ç»“æœæ•°æ®è·¯å¾„å­—å…¸
  - `label_column`: çœŸå®æ ‡ç­¾åˆ—å
  - `prediction_column`: é¢„æµ‹æ¦‚ç‡åˆ—å
  - `bucket_size`: åˆ†æ¡¶æ•°é‡ï¼Œé»˜è®¤10
  - `output_report`: è¯„ä¼°æŠ¥å‘Šè¾“å‡ºè·¯å¾„ï¼ˆJSONæ ¼å¼ï¼‰

#### RegressionEvalï¼ˆå›å½’è¯„ä¼°ï¼‰
- **æ–‡ä»¶**: `evaluation/regression_eval_task.py`
- **ä»»åŠ¡ç±»å‹**: `regression_eval`
- **åŠŸèƒ½**: è®¡ç®—å›å½’æ¨¡å‹çš„è¯„ä¼°æŒ‡æ ‡
- **SecretFlow API**: `secretflow.stats.RegressionEval`
- **è¯„ä¼°æŒ‡æ ‡**:
  - MSEï¼ˆMean Squared Errorï¼‰
  - RMSEï¼ˆRoot Mean Squared Errorï¼‰
  - MAEï¼ˆMean Absolute Errorï¼‰
  - MAPEï¼ˆMean Absolute Percentage Errorï¼‰
  - RÂ² Scoreï¼ˆå†³å®šç³»æ•°ï¼‰
  - Explained Varianceï¼ˆè§£é‡Šæ–¹å·®ï¼‰
- **å‚æ•°**:
  - `prediction_data`: é¢„æµ‹ç»“æœæ•°æ®è·¯å¾„å­—å…¸
  - `label_column`: çœŸå®æ ‡ç­¾åˆ—å
  - `prediction_column`: é¢„æµ‹å€¼åˆ—å
  - `output_report`: è¯„ä¼°æŠ¥å‘Šè¾“å‡ºè·¯å¾„ï¼ˆJSONæ ¼å¼ï¼‰

## ä»£ç å˜æ›´ç»Ÿè®¡

### æ–°å»ºæ–‡ä»¶

| æ–‡ä»¶ | è¡Œæ•° | è¯´æ˜ |
|-----|------|------|
| `stats/__init__.py` | 17 | Statså­æ¨¡å—å¯¼å‡º |
| `stats/table_statistics_task.py` | 116 | è¡¨ç»Ÿè®¡åˆ†æä»»åŠ¡ |
| `stats/pearson_correlation_task.py` | 120 | Pearsonç›¸å…³æ€§åˆ†æä»»åŠ¡ |
| `stats/vif_task.py` | 142 | VIFæ–¹å·®è†¨èƒ€å› å­ä»»åŠ¡ |
| `evaluation/__init__.py` | 14 | Evaluationå­æ¨¡å—å¯¼å‡º |
| `evaluation/biclassification_eval_task.py` | 149 | äºŒåˆ†ç±»è¯„ä¼°ä»»åŠ¡ |
| `evaluation/regression_eval_task.py` | 147 | å›å½’è¯„ä¼°ä»»åŠ¡ |

**æ€»è®¡**: 7ä¸ªæ–°æ–‡ä»¶ï¼Œçº¦705è¡Œä»£ç 

### ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|-----|---------|
| `jobs/__init__.py` | æ·»åŠ statså’Œevaluationæ¨¡å—å¯¼å‡º |
| `docs/04.2.secretpad_work_list.md` | æ›´æ–°ä»»åŠ¡çŠ¶æ€å’Œæ–‡ä»¶è·¯å¾„ |

### ä¿ç•™æ–‡ä»¶

- `stats_task.py`: ä¿ç•™åŸæ–‡ä»¶ï¼ˆä»…æœ‰æ³¨é‡Šï¼‰ï¼Œå¾…åç»­åˆ é™¤

## æŠ€æœ¯å®ç°

### 1. ä»»åŠ¡æ³¨å†Œ

æ‰€æœ‰ä»»åŠ¡ä½¿ç”¨`@TaskDispatcher.register_task()`è£…é¥°å™¨æ³¨å†Œï¼š

```python
@TaskDispatcher.register_task("table_statistics")
def execute_table_statistics(devices: Dict[str, PYU], task_config: Dict) -> Dict:
    """æ‰§è¡Œè¡¨ç»Ÿè®¡åˆ†æä»»åŠ¡"""
    pass
```

### 2. ç›´æ¥ä½¿ç”¨SecretFlow API

æ‰€æœ‰ä»»åŠ¡ç›´æ¥è°ƒç”¨SecretFlowæä¾›çš„APIï¼Œæ— éœ€è‡ªå·±å®ç°ç®—æ³•ï¼š

```python
from secretflow.stats import table_statistics

# è®¡ç®—è¡¨ç»Ÿè®¡ä¿¡æ¯
stats_df = table_statistics(vdf)
```

### 3. ç»“æœJSONåºåˆ—åŒ–

æ‰€æœ‰ç»Ÿè®¡å’Œè¯„ä¼°ç»“æœä¿å­˜ä¸ºJSONæ ¼å¼ï¼Œä¾¿äºæŸ¥çœ‹å’Œä½¿ç”¨ï¼š

```python
# å°†ç»Ÿè®¡ç»“æœè½¬æ¢ä¸ºå­—å…¸æ ¼å¼
stats_dict = {}
for col in stats_df.index:
    stats_dict[col] = {}
    for stat_name in stats_df.columns:
        value = stats_df.loc[col, stat_name]
        # å¤„ç†NaNå’Œç‰¹æ®Šå€¼
        if str(value) == 'nan' or value != value:
            value = None
        stats_dict[col][stat_name] = value

# ä¿å­˜ä¸ºJSON
with open(output_report, 'w', encoding='utf-8') as f:
    json.dump(stats_dict, f, indent=2, ensure_ascii=False)
```

### 4. æ—¥å¿—è®°å½•

ä½¿ç”¨ç»Ÿä¸€çš„loguruæ—¥å¿—ç³»ç»Ÿï¼š

```python
from utils.log import logger

logger.info("å¼€å§‹æ‰§è¡Œè¡¨ç»Ÿè®¡åˆ†æä»»åŠ¡")
logger.error(f"è¡¨ç»Ÿè®¡åˆ†æä»»åŠ¡æ‰§è¡Œå¤±è´¥: {e}", exc_info=True)
```

## ä½¿ç”¨ç¤ºä¾‹

### TableStatisticsç¤ºä¾‹

```python
devices = {
    "alice": sf.PYU('alice'),
    "bob": sf.PYU('bob'),
}

task_config = {
    "input_data": {
        "alice": "/data/alice_train.csv",
        "bob": "/data/bob_train.csv"
    },
    "columns": ["age", "income", "score"],  # å¯é€‰
    "output_report": "/reports/table_stats.json"
}

result = TaskDispatcher.dispatch("table_statistics", devices, task_config)
```

### PearsonCorrelationç¤ºä¾‹

```python
devices = {
    "alice": sf.PYU('alice'),
    "bob": sf.PYU('bob'),
    "spu": sf.SPU(...)  # éœ€è¦SPUè®¾å¤‡
}

task_config = {
    "input_data": {
        "alice": "/data/alice_train.csv",
        "bob": "/data/bob_train.csv"
    },
    "columns": ["age", "income", "score"],
    "output_report": "/reports/correlation.json"
}

result = TaskDispatcher.dispatch("pearson_correlation", devices, task_config)
```

### BiClassificationEvalç¤ºä¾‹

```python
task_config = {
    "prediction_data": {
        "alice": "/data/alice_predictions.csv"
    },
    "label_column": "label",
    "prediction_column": "probability",
    "bucket_size": 10,
    "output_report": "/reports/biclass_eval.json"
}

result = TaskDispatcher.dispatch("biclassification_eval", devices, task_config)
# è¾“å‡º: {"auc": 0.85, "ks": 0.45, "f1_score": 0.78, ...}
```

### RegressionEvalç¤ºä¾‹

```python
task_config = {
    "prediction_data": {
        "alice": "/data/alice_predictions.csv"
    },
    "label_column": "actual_value",
    "prediction_column": "predicted_value",
    "output_report": "/reports/regression_eval.json"
}

result = TaskDispatcher.dispatch("regression_eval", devices, task_config)
# è¾“å‡º: {"mse": 0.25, "rmse": 0.50, "mae": 0.40, "r2_score": 0.85, ...}
```

## ä¸SecretFlowçš„å¯¹åº”å…³ç³»

| SecretFlow API | æˆ‘ä»¬çš„ä»»åŠ¡ | è¯´æ˜ |
|---------------|-----------|------|
| `secretflow.stats.table_statistics` | `table_statistics` | è¡¨ç»Ÿè®¡åˆ†æ |
| `secretflow.stats.SSVertPearsonR` | `pearson_correlation` | Pearsonç›¸å…³æ€§ |
| `secretflow.stats.SSVertVIF` | `vif` | æ–¹å·®è†¨èƒ€å› å­ |
| `secretflow.stats.BiClassificationEval` | `biclassification_eval` | äºŒåˆ†ç±»è¯„ä¼° |
| `secretflow.stats.RegressionEval` | `regression_eval` | å›å½’è¯„ä¼° |

## åç»­å·¥ä½œ

### å¾…å®Œæˆä»»åŠ¡

1. **å•å…ƒæµ‹è¯•**: ä¸ºæ‰€æœ‰statså’Œevaluationä»»åŠ¡æ·»åŠ å•å…ƒæµ‹è¯•
2. **é›†æˆæµ‹è¯•**: æµ‹è¯•ä»»åŠ¡ä¹‹é—´çš„ç»„åˆä½¿ç”¨
3. **WOE/IVä»»åŠ¡**: æ·»åŠ WOE/IVè®¡ç®—ä»»åŠ¡ï¼ˆä½¿ç”¨ScoreCardç±»ï¼‰
4. **æ–‡æ¡£å®Œå–„**: æ·»åŠ æ›´è¯¦ç»†çš„ä½¿ç”¨æ–‡æ¡£å’Œç¤ºä¾‹

### æ‰©å±•æ–¹å‘

1. **æ›´å¤šç»Ÿè®¡åˆ†æ**: æ·»åŠ P-Valueã€GroupByç»Ÿè®¡ç­‰
2. **é¢„æµ‹åå·®è¯„ä¼°**: æ·»åŠ prediction_bias_evalä»»åŠ¡
3. **PSIè¯„ä¼°**: æ·»åŠ psi_evalä»»åŠ¡
4. **è‡ªå®šä¹‰è¯„ä¼°æŒ‡æ ‡**: æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰è¯„ä¼°æŒ‡æ ‡

## æœ€ä½³å®è·µ

### 1. ç›´æ¥ä½¿ç”¨SecretFlow API

- ä¼˜å…ˆä½¿ç”¨SecretFlowæä¾›çš„API
- é¿å…é‡å¤å®ç°å·²æœ‰åŠŸèƒ½
- ä¿æŒä¸SecretFlowçš„ä¸€è‡´æ€§

### 2. ç»“æœæ ¼å¼åŒ–

- ç»Ÿä¸€ä½¿ç”¨JSONæ ¼å¼ä¿å­˜ç»“æœ
- å¤„ç†NaNå’Œç‰¹æ®Šå€¼
- æä¾›å‹å¥½çš„ç»“æœå±•ç¤º

### 3. é”™è¯¯å¤„ç†

- å®Œæ•´çš„å¼‚å¸¸æ•è·
- è¯¦ç»†çš„æ—¥å¿—è®°å½•
- å‹å¥½çš„é”™è¯¯æç¤º

### 4. è®¾å¤‡ç®¡ç†

- æ­£ç¡®éªŒè¯è®¾å¤‡é…ç½®
- åŒºåˆ†PYUå’ŒSPUè®¾å¤‡
- åˆç†ä½¿ç”¨è®¾å¤‡èµ„æº

## æ€»ç»“

### é‡æ„æˆæœ

1. âœ… **ç›®å½•ç»“æ„æ¸…æ™°**
   - æŒ‰åŠŸèƒ½åˆ†ç±»ç»„ç»‡
   - statså’Œevaluationç‹¬ç«‹
   - ç¬¦åˆSecretFlowé£æ ¼

2. âœ… **åŠŸèƒ½å®Œæ•´**
   - 5ä¸ªç»Ÿè®¡å’Œè¯„ä¼°ä»»åŠ¡
   - è¦†ç›–å¸¸ç”¨åœºæ™¯
   - ç›´æ¥ä½¿ç”¨SecretFlow API

3. âœ… **ä»£ç è´¨é‡é«˜**
   - ç»Ÿä¸€çš„æ—¥å¿—ç³»ç»Ÿ
   - å®Œæ•´çš„é”™è¯¯å¤„ç†
   - æ¸…æ™°çš„æ–‡æ¡£æ³¨é‡Š

4. âœ… **æ˜“äºæ‰©å±•**
   - æ¨¡å—åŒ–è®¾è®¡
   - ç‹¬ç«‹çš„ä»»åŠ¡æ–‡ä»¶
   - ç»Ÿä¸€çš„æ¥å£

### æ ¸å¿ƒä¼˜åŠ¿

**ä»ç©ºæ–‡ä»¶åˆ°å®Œæ•´æ¨¡å—**:
- å®ç°äº†5ä¸ªæ ¸å¿ƒç»Ÿè®¡å’Œè¯„ä¼°ä»»åŠ¡
- ç›´æ¥ä½¿ç”¨SecretFlowæˆç†ŸAPI
- æ— éœ€é‡å¤é€ è½®å­
- ä¿è¯åŠŸèƒ½æ­£ç¡®æ€§å’Œæ€§èƒ½

**Statså’ŒEvaluationä»»åŠ¡æ¨¡å—é‡æ„å®Œæˆï¼** ğŸ‰
