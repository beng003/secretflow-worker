# 日志系统统一修改总结

## 修改概述

**完成日期**: 2026-01-05  
**目标**: 将`secretflow_task`模块中的标准库`logging`统一改为使用`utils/log.py`中的loguru logger

## 修改动机

### 原有问题

**分散的日志管理**:
- 各模块使用标准库`logging.getLogger(__name__)`
- 日志格式不统一
- 缺乏统一的日志配置
- 难以集中管理日志输出

**标准库logging的局限**:
- 配置复杂
- 格式化不够灵活
- 缺少彩色输出
- 日志轮转配置繁琐

## 解决方案

### 统一日志工具

使用`utils/log.py`中基于loguru的日志系统：

**优势**:
- ✅ 统一的日志格式
- ✅ 彩色控制台输出
- ✅ 自动日志轮转和压缩
- ✅ 更好的异常追踪
- ✅ 简单的配置管理

### 日志格式

**控制台输出**（带颜色）:
```
2026-01-05 20:58:26.107 | INFO     | PID:3791129 | secretflow_task.jobs.psi_task:execute_psi:142 | 开始执行PSI任务
```

**文件输出**（无颜色）:
```
2026-01-05 20:58:26.107 | INFO     | PID:3791129 | secretflow_task.jobs.psi_task:execute_psi:142 | 开始执行PSI任务
```

**格式说明**:
- 时间戳: `YYYY-MM-DD HH:mm:ss.SSS`
- 日志级别: `INFO`, `DEBUG`, `WARNING`, `ERROR`
- 进程ID: `PID:xxxxx`
- 模块路径: `module:function:line`
- 日志消息

## 修改的文件

### 1. task_dispatcher.py

**修改前**:
```python
import logging
logger = logging.getLogger(__name__)
```

**修改后**:
```python
from utils.log import logger
```

### 2. jobs/psi_task.py

**修改前**:
```python
import logging
logger = logging.getLogger(__name__)
```

**修改后**:
```python
from utils.log import logger
```

### 3. jobs/linear/ss_lr_task.py

**修改前**:
```python
import logging
logger = logging.getLogger(__name__)
```

**修改后**:
```python
from utils.log import logger
```

### 4. jobs/boost/ss_xgb_task.py

**修改前**:
```python
import logging
logger = logging.getLogger(__name__)
```

**修改后**:
```python
from utils.log import logger
```

### 5. jobs/preprocessing_task.py

**修改前**:
```python
import logging
logger = logging.getLogger(__name__)
```

**修改后**:
```python
from utils.log import logger
```

## 日志配置

### utils/log.py配置

**日志级别**:
- 开发模式: `DEBUG`
- 生产模式: `INFO`

**日志输出**:
1. **控制台输出**
   - 带颜色
   - 实时显示
   - 支持异常追踪

2. **文件输出 - 全量日志**
   - 路径: `logs/backend_YYYY-MM-DD.log`
   - 级别: `DEBUG`
   - 轮转: 100 MB
   - 保留: 30 天
   - 压缩: zip

3. **文件输出 - 错误日志**
   - 路径: `logs/backend_error_YYYY-MM-DD.log`
   - 级别: `ERROR`
   - 轮转: 50 MB
   - 保留: 90 天
   - 压缩: zip

## 代码变更统计

### 修改的模块

| 文件 | 修改行数 | 说明 |
|-----|---------|------|
| `task_dispatcher.py` | 2 | 移除logging导入，添加utils.log导入 |
| `jobs/psi_task.py` | 2 | 移除logging导入，添加utils.log导入 |
| `jobs/linear/ss_lr_task.py` | 2 | 移除logging导入，添加utils.log导入 |
| `jobs/boost/ss_xgb_task.py` | 2 | 移除logging导入，添加utils.log导入 |
| `jobs/preprocessing_task.py` | 2 | 移除logging导入，添加utils.log导入 |

**总计**: 5个文件，10行修改

## 测试验证

### 测试结果

```bash
pytest tests/unit/test_psi_task.py::TestExecutePSI::test_execute_psi_success -v -s
```

**日志输出示例**:
```
2026-01-05 20:58:20.344 | INFO | PID:3791129 | utils.log:setup_logger:90 | 日志系统已启动
2026-01-05 20:58:20.347 | INFO | PID:3791129 | secretflow_task.task_dispatcher:decorator:64 | 成功注册任务类型: 'psi' -> execute_psi
2026-01-05 20:58:26.107 | INFO | PID:3791129 | secretflow_task.jobs.psi_task:execute_psi:142 | 开始执行PSI任务
2026-01-05 20:58:26.107 | INFO | PID:3791129 | secretflow_task.jobs.psi_task:execute_psi:160 | PSI配置: protocol=KKRT_PSI_2PC, receiver=alice, parties=['alice', 'bob']
```

**验证结果**: ✅ 所有测试通过，日志格式统一

## 日志使用示例

### 基本用法

```python
from utils.log import logger

# INFO级别
logger.info("开始执行任务")

# DEBUG级别
logger.debug(f"配置参数: {config}")

# WARNING级别
logger.warning("配置项缺失，使用默认值")

# ERROR级别
logger.error(f"任务执行失败: {e}")

# 带异常追踪
try:
    # some code
    pass
except Exception as e:
    logger.exception("发生异常")  # 自动包含堆栈信息
```

### 上下文信息

```python
# 添加上下文
with logger.contextualize(task_id="123", user="alice"):
    logger.info("执行任务")  # 日志会包含task_id和user信息
```

### 性能日志

```python
import time

start_time = time.time()
# 执行任务
elapsed = time.time() - start_time
logger.info(f"任务执行完成，耗时: {elapsed:.2f}秒")
```

## 日志最佳实践

### 1. 日志级别使用

**DEBUG**: 详细的调试信息
```python
logger.debug(f"读取数据: {data_path}")
logger.debug(f"参数值: features={features}, label={label}")
```

**INFO**: 重要的业务流程信息
```python
logger.info("开始执行PSI任务")
logger.info(f"模型训练完成，共 {num_trees} 棵树")
```

**WARNING**: 警告信息，不影响运行但需要注意
```python
logger.warning("配置项缺失，使用默认值")
logger.warning(f"接收方输出文件不存在: {path}")
```

**ERROR**: 错误信息，影响功能但不致命
```python
logger.error(f"PSI任务配置错误: {e}")
logger.error(f"模型加载失败: {e}")
```

### 2. 结构化日志

**推荐**:
```python
logger.info(f"PSI配置: protocol={protocol}, receiver={receiver}, parties={parties}")
```

**不推荐**:
```python
logger.info(f"PSI配置: {protocol} {receiver} {parties}")  # ❌ 不够清晰
```

### 3. 异常处理

**推荐**:
```python
try:
    # some code
    pass
except ValueError as e:
    logger.error(f"配置错误: {e}")
    raise
except Exception as e:
    logger.exception("未预期的错误")  # 自动包含堆栈
    raise RuntimeError(f"任务执行失败: {str(e)}") from e
```

### 4. 避免敏感信息

**不要记录**:
- 密码、密钥
- 个人隐私数据
- 完整的数据内容

**推荐**:
```python
logger.info(f"加载模型: {model_path}")  # ✅ 只记录路径
logger.info(f"数据行数: {len(data)}")   # ✅ 只记录统计信息
```

**不推荐**:
```python
logger.info(f"数据内容: {data}")  # ❌ 可能泄露隐私
```

## 日志文件管理

### 日志目录结构

```
logs/
├── backend_2026-01-05.log          # 当天全量日志
├── backend_2026-01-04.log.zip      # 历史日志（压缩）
├── backend_error_2026-01-05.log    # 当天错误日志
└── backend_error_2026-01-04.log.zip # 历史错误日志（压缩）
```

### 日志清理

**自动清理**:
- 全量日志: 保留30天
- 错误日志: 保留90天
- 自动压缩为zip格式

**手动清理**:
```bash
# 清理30天前的日志
find logs/ -name "*.log.zip" -mtime +30 -delete
```

## 与其他系统集成

### Celery日志

Celery任务会自动使用统一的日志系统：

```python
from celery import shared_task
from utils.log import logger

@shared_task
def my_task():
    logger.info("Celery任务开始")
    # task logic
    logger.info("Celery任务完成")
```

### Ray Worker日志

Ray worker进程会继承主进程的日志配置：

```python
# 在PYU上执行的函数也会使用统一日志
def worker_function():
    from utils.log import logger
    logger.info("Worker函数执行")
```

## 监控与告警

### 日志监控

可以使用以下工具监控日志：

1. **ELK Stack** (Elasticsearch + Logstash + Kibana)
2. **Grafana Loki**
3. **Prometheus + Alertmanager**

### 告警规则示例

```yaml
# 错误日志告警
- alert: HighErrorRate
  expr: rate(log_errors_total[5m]) > 10
  annotations:
    summary: "错误日志频率过高"
```

## 迁移指南

### 对于新模块

**直接使用统一日志**:
```python
from utils.log import logger

def my_function():
    logger.info("执行功能")
```

### 对于旧代码

**替换步骤**:
1. 移除`import logging`
2. 移除`logger = logging.getLogger(__name__)`
3. 添加`from utils.log import logger`
4. 测试验证

## 总结

### 修改成果

1. ✅ **日志系统统一**
   - 所有模块使用相同的日志工具
   - 统一的日志格式
   - 集中的日志配置

2. ✅ **日志功能增强**
   - 彩色控制台输出
   - 自动日志轮转
   - 更好的异常追踪
   - 结构化日志支持

3. ✅ **运维友好**
   - 自动压缩和清理
   - 分级日志文件
   - 易于集成监控系统

4. ✅ **开发体验提升**
   - 简单的API
   - 清晰的日志输出
   - 便于调试

### 核心优势

**从标准库logging到loguru的升级**:
- 更简单的配置
- 更强大的功能
- 更好的性能
- 更优的开发体验

**日志系统统一完成！** 🎉
