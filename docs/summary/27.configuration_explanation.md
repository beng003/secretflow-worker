# SecretFlow配置说明文档

## 📋 配置变更说明

### 问题1：IP地址配置统一

**问题**：配置中存在多个IP地址变量（`NODE_IP`和`RAY_NODE_IP`），容易混淆。

**解决方案**：
- ✅ 统一使用`NODE_IP`作为唯一的节点IP配置
- ✅ 移除`RAY_NODE_IP`变量
- ✅ 所有需要节点IP的地方都使用`NODE_IP`

**配置示例**：
```bash
# 节点IP地址（宿主机真实IP）
NODE_IP=***.***.***.***

# Ray头节点地址（使用NODE_IP）
RAY_HEAD_ADDRESS=***.***.***.***:61379
```

---

### 问题2：Ray端口配置

**问题**：Ray端口如何配置？

**答案**：使用`ray start`命令行可以指定端口。

**技术细节**：

我们使用`ray start`命令启动Ray集群，可以通过`--port`参数指定GCS端口：

```bash
# CLI方式（当前使用）
ray start --head \
    --node-ip-address="${NODE_IP}" \
    --port="${RAY_PORT:-61379}" \
    --num-cpus="${RAY_NUM_CPUS:-0}" \
    --include-dashboard=False \
    --disable-usage-stats
```

**配置说明**：
```bash
# 配置文件
RAY_PORT=61379  # Ray GCS端口

# 实际运行
Ray会在指定的端口启动GCS服务
```

**注意事项**：
- `ray status`命令在Python 3.10下可能有兼容性问题
- 但`ray start`命令可以正常工作
- 健康检查使用进程检查而非`ray status`

---

### 问题3：Ray集群架构（重要更新）

**关键发现**：根据SecretFlow官方架构，**每个节点都启动独立的Ray集群（头节点模式）**，不需要Ray worker节点。

**架构说明**：

#### 单节点部署
```
┌─────────────────────────────────┐
│  节点1 (***.***.***.***)         │
├─────────────────────────────────┤
│  Redis (60379)                  │
│  Ray集群 (独立头节点)            │
│  Celery Worker                  │
│    └─> 任务执行时通过sf.init()  │
│        连接到本地Ray集群         │
└─────────────────────────────────┘
```

**配置**：
```bash
NODE_ID=node1
NODE_IP=***.***.***.***
RAY_PORT=61379  # 参考值，实际端口自动选择
```

#### 多节点部署
```
┌─────────────────────────────────┐     ┌─────────────────────────────────┐
│  节点1 (192.168.1.10)           │     │  节点2 (192.168.1.11)           │
├─────────────────────────────────┤     ├─────────────────────────────────┤
│  Redis (60379)                  │     │  Redis (60379)                  │
│  Ray集群 (独立头节点)            │     │  Ray集群 (独立头节点)            │
│  Celery Worker                  │     │  Celery Worker                  │
│    └─> sf.init(cluster_config)  │     │    └─> sf.init(cluster_config)  │
└─────────────────────────────────┘     └─────────────────────────────────┘
         ↑                                         ↑
         └─────────── SecretFlow通信 ──────────────┘
         (通过cluster_config配置，不是Ray worker连接)
```

**节点1配置**：
```bash
NODE_ID=node1
NODE_IP=192.168.1.10
RAY_PORT=61379
```

**节点2配置**：
```bash
NODE_ID=node2
NODE_IP=192.168.1.11
RAY_PORT=61379
```

**多节点通信方式**：
各节点通过SecretFlow的`cluster_config`进行通信，而不是通过Ray的worker节点连接。

```python
# 节点1的任务代码
cluster_config = {
    'parties': {
        'alice': {'address': '192.168.1.10:19000', 'listen_addr': '0.0.0.0:19000'},
        'bob': {'address': '192.168.1.11:19000', 'listen_addr': '0.0.0.0:19000'},
    },
    'self_party': 'alice'
}
sf.init(address='本地Ray地址', cluster_config=cluster_config)
```

---

### 问题4：其他节点如何使用NODE_IP

**SecretFlow任务执行时的节点通信**：

当Web层发起多方计算任务时，会传递所有参与节点的信息：

```python
# 任务参数示例
task_params = {
    "nodes": [
        {
            "node_id": "node1",
            "node_ip": "***.***.***.***",  # 使用NODE_IP
            "sf_port": 19000,
            "spu_port": 19500
        },
        {
            "node_id": "node2", 
            "node_ip": "192.168.1.11",    # 使用NODE_IP
            "sf_port": 19100,
            "spu_port": 19600
        }
    ]
}
```

**节点间通信流程**：
1. Web层收集所有参与节点的`NODE_IP`和端口信息
2. 将完整的节点列表作为任务参数传递给每个Worker
3. 每个Worker使用这些信息建立SecretFlow集群连接
4. SecretFlow使用`NODE_IP`进行节点间通信

---

## 🔧 配置文件结构

### 环境变量优先级

```
1. NODE_IP          - 节点IP（唯一）
2. RAY_HEAD_ADDRESS - Ray头节点地址（使用NODE_IP构建）
3. RAY_PORT         - Ray端口（参考值，实际由Ray自动选择）
```

### 必需配置项

**所有节点必需**：
- `NODE_ID` - 节点唯一标识
- `NODE_IP` - 节点IP地址
- `APP_ENV` - 运行环境（production）
- `REDIS_HOST` - Redis主机（127.0.0.1）
- `REDIS_PORT` - Redis端口

**Ray配置**：
- `RAY_NODE_TYPE` - head或worker
- `RAY_HEAD_ADDRESS` - 头节点地址
- `RAY_PORT` - 端口参考值
- `RAY_NUM_CPUS` - CPU数量（0=全部）
- `RAY_OBJECT_STORE_MEMORY` - 对象存储内存

**SecretFlow端口范围**：
- `SF_PORT_RANGE_START/END` - SecretFlow通信端口
- `SPU_PORT_RANGE_START/END` - SPU端口
- `HEU_PORT_RANGE_START/END` - HEU端口

---

## 📝 配置示例

### 单节点部署

```bash
# .env.production
NODE_ID=node1
NODE_IP=***.***.***.***
APP_ENV=production
RAY_NODE_TYPE=head
RAY_HEAD_ADDRESS=***.***.***.***:61379
RAY_PORT=61379
SF_PORT_RANGE_START=19000
SF_PORT_RANGE_END=19009
```

### 多节点部署

**节点1（头节点）**：
```bash
NODE_ID=node1
NODE_IP=192.168.1.10
RAY_NODE_TYPE=head
RAY_HEAD_ADDRESS=192.168.1.10:61379
SF_PORT_RANGE_START=19000
SF_PORT_RANGE_END=19009
```

**节点2（工作节点）**：
```bash
NODE_ID=node2
NODE_IP=192.168.1.11
RAY_NODE_TYPE=worker
RAY_HEAD_ADDRESS=192.168.1.10:61379  # 指向节点1
SF_PORT_RANGE_START=19100
SF_PORT_RANGE_END=19109
```

---

## ⚠️ 注意事项

1. **IP地址一致性**：确保`NODE_IP`与`RAY_HEAD_ADDRESS`中的IP一致
2. **端口范围不重叠**：不同节点的SecretFlow端口范围不能重叠
3. **Ray端口自动选择**：实际端口可能与配置不同，以日志为准
4. **防火墙配置**：确保节点间可以通过`NODE_IP`互相访问

---

**文档版本**：v2.0  
**最后更新**：2026年1月6日
