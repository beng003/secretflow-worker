# SecretFlow Worker API 文档

## 概述

本文档定义了 Web 容器与 SecretFlow Worker 容器之间的任务接口规范。Web 容器通过 Celery 消息队列向 Worker 容器发送任务，Worker 容器执行 SecretFlow 计算后返回结果。

## 通用任务结构

所有任务都遵循统一的请求格式：

```python
{
    "task_id": "task-uuid-from-db",           # 必需，归属的大任务/DAG ID
    "subtask_id": "subtask-uuid-from-db",     # 必需，子任务/节点 ID
    "execution_id": "exec-uuid-from-db",      # 必需，本次执行记录 ID (原 task_request_id)
    
    "sf_init_config": {                       # 必需，SecretFlow集群初始化配置（详见下文）
        ...
    },
    "spu_config": {                           # 可选，SPU设备配置（需要密态计算时必需）
        ...
    },
    "task_config": {                          # 必需，具体任务配置
        "task_type": "任务类型",             # 必需，任务类型标识符
        ...                                   # 任务特定参数
    }
}
```

### SecretFlow集群配置（sf_init_config）

SecretFlow支持两种集群配置模式：**本地模式**和**集群模式**。

#### 方式一：本地模式（推荐用于开发测试）

本地模式使用简化配置，所有参与方在同一进程中运行。

```python
"sf_init_config": {
    "parties": ["alice", "bob"],           # 必需，参与方列表
    "address": "local"                     # 必需，使用"local"表示本地模式
}
```

**特点：**
- 配置简单，适合开发和测试
- 所有参与方在同一进程，不需要网络通信
- 性能较好，启动快速

#### 方式二：集群模式（用于生产或多节点部署）

集群模式需要为每个参与方配置独立的地址和监听地址。

```python
"sf_init_config": {
    "parties": {
        "alice": {
            "address": "127.0.0.1:7700",      # alice的通信地址
            "listen_addr": "0.0.0.0:7700"     # alice的监听地址
        },
        "bob": {
            "address": "127.0.0.1:7800",      # bob的通信地址
            "listen_addr": "0.0.0.0:7800"     # bob的监听地址
        }
    },
    "self_party": "alice",                     # 必需，当前节点的参与方名称
    "address": "127.0.0.1:7701"               # 可选，Ray集群地址
}
```

**特点：**
- 支持多节点分布式部署
- 每个参与方独立运行，真实模拟生产环境
- 需要配置网络地址和端口

**参数说明：**
- `address`: 参与方对外通信的地址（其他节点连接此地址）
- `listen_addr`: 参与方监听的地址（通常使用0.0.0.0监听所有网卡）
- `self_party`: 当前Worker容器所属的参与方（多节点部署时必需）

#### 方式三：Ray集群模式

适用于需要连接已有Ray集群的场景。

```python
"sf_init_config": {
    "parties": ["alice", "bob"],
    "address": "ray://127.0.0.1:10001",    # Ray集群head节点地址
    "num_cpus": 8,                          # 可选，分配的CPU数量
    "log_to_driver": True,                  # 可选，日志输出到driver
    "omp_num_threads": 1                    # 可选，OpenMP线程数
}
```

### SPU设备配置（spu_config）

SPU（Secure Processing Unit）用于密态计算，需要PSI、机器学习等隐私计算任务时必需配置。

```python
"spu_config": {
    "cluster_def": {
        "nodes": [                          # 必需，SPU节点列表
            {
                "party": "alice",           # 参与方名称
                "address": "127.0.0.1:12345"  # SPU通信地址
            },
            {
                "party": "bob",
                "address": "127.0.0.1:12346"
            }
        ],
        "runtime_config": {
            "protocol": "SEMI2K",           # 必需，MPC协议
            "field": "FM128"                # 必需，有限域
        }
    }
}
```

**协议选项（protocol）：**
- `SEMI2K`: 半诚实二方协议（推荐，性能好）
- `ABY3`: 三方协议
- `CHEETAH`: 高性能协议

**有限域选项（field）：**
- `FM64`: 64位有限域
- `FM128`: 128位有限域（推荐，精度高）

## 任务发送示例

### Celery任务名称
```python
task_name = "tasks.secretflow.execute_task"
queue = "secretflow_queue"
```

### Python示例
```python
from celery import Celery

app = Celery('secretflow_sender', 
             broker='redis://127.0.0.1:60379/0',
             backend='redis://127.0.0.1:60379/0')

task_params = {
    "task_id": "task-uuid-from-db",
    "subtask_id": "subtask-uuid-from-db", 
    "execution_id": "exec-uuid-from-db",
    "sf_init_config": {...},
    "spu_config": {...},
    "task_config": {...}
}

result = app.send_task(
    "tasks.secretflow.execute_task",
    args=[task_params],
    queue="secretflow_queue"
)

# 获取任务结果
task_result = result.get(timeout=300)
```

---

## 支持的任务类型

### 目录结构
```
src/secretflow_task/jobs/
├── psi_task.py                      # PSI隐私求交
├── linear/
│   └── ss_lr_task.py               # 逻辑回归
├── boost/
│   └── ss_xgb_task.py              # XGBoost
├── preprocessing/
│   ├── scaler/
│   │   ├── standard_scaler_task.py # 标准化
│   │   └── minmax_scaler_task.py   # 归一化
│   ├── encoder/
│   │   ├── label_encoder_task.py   # 标签编码
│   │   └── onehot_encoder_task.py  # 独热编码
│   ├── binning/
│   │   ├── quantile_binning_task.py   # 分位数分箱
│   │   └── equal_width_binning_task.py # 等宽分箱
│   └── fillna/
│       └── fillna_task.py          # 缺失值填充
├── stats/
│   ├── table_statistics_task.py    # 表统计
│   ├── pearson_correlation_task.py # 皮尔逊相关系数
│   └── vif_task.py                 # 方差膨胀因子
└── evaluation/
    ├── biclassification_eval_task.py  # 二分类评估
    └── regression_eval_task.py        # 回归评估
```

---

## 1. PSI（隐私集合求交）

### 任务类型
```python
task_type = "psi"
```

### 任务配置
```python
{
    "task_type": "psi",
    "keys": {                          # 必需，各方用于求交的键列
        "alice": ["uid"],              # alice方的键列列表
        "bob": ["uid"]                 # bob方的键列列表
    },
    "input_paths": {                   # 必需，各方输入数据路径
        "alice": "/app/data/alice.csv",
        "bob": "/app/data/bob.csv"
    },
    "output_paths": {                  # 必需，各方输出数据路径
        "alice": "/app/data/alice_psi_out.csv",
        "bob": "/app/data/bob_psi_out.csv"
    },
    "receiver": "alice",               # 必需，接收结果的参与方
    "protocol": "KKRT_PSI_2PC",       # 可选，PSI协议（默认KKRT_PSI_2PC）
    "sort": true                       # 可选，是否对结果排序（默认false）
}
```

### 完整示例

#### 示例1：使用本地模式（推荐用于开发测试）

```python
task_params = {
    "task_id": "dag-12345-abcde",
    "subtask_id": "node-67890-fghij", 
    "execution_id": "exec-11111-klmno",
    
    "sf_init_config": {
        "parties": ["alice", "bob"],       # 参与方列表
        "address": "local"                 # 本地模式
    },
    "spu_config": {
        "cluster_def": {
            "nodes": [
                {"party": "alice", "address": "127.0.0.1:12345"},
                {"party": "bob", "address": "127.0.0.1:12346"}
            ],
            "runtime_config": {
                "protocol": "SEMI2K",
                "field": "FM128"
            }
        }
    },
    "task_config": {
        "task_type": "psi",
        "keys": {
            "alice": ["uid"],
            "bob": ["uid"]
        },
        "input_paths": {
            "alice": "/app/data/alice.csv",
            "bob": "/app/data/bob.csv"
        },
        "output_paths": {
            "alice": "/app/data/alice_psi_out.csv",
            "bob": "/app/data/bob_psi_out.csv"
        },
        "receiver": "alice",
        "protocol": "KKRT_PSI_2PC",
        "sort": true
    }
}
```

#### 示例2：使用集群模式（用于生产或多节点部署）

当alice和bob在不同Worker容器时使用集群模式：

**Alice节点发送的任务：**
```python
task_params = {
    "task_id": "dag-alice-001",
    "subtask_id": "psi-node-alice", 
    "execution_id": "exec-alice-001-001",
    
    "sf_init_config": {
        "parties": {
            "alice": {
                "address": "127.0.0.1:7700",      # alice节点地址
                "listen_addr": "0.0.0.0:7700"     # alice监听地址
            },
            "bob": {
                "address": "192.168.1.100:7800",  # bob节点地址（远程）
                "listen_addr": "0.0.0.0:7800"     # bob监听地址
            }
        },
        "self_party": "alice",                     # 当前节点是alice
        "address": "127.0.0.1:7701"               # Ray集群地址
    },
    "spu_config": {
        "cluster_def": {
            "nodes": [
                {"party": "alice", "address": "127.0.0.1:12345"},
                {"party": "bob", "address": "192.168.1.100:12346"}  # bob的SPU地址
            ],
            "runtime_config": {
                "protocol": "SEMI2K",
                "field": "FM128"
            }
        }
    },
    "task_config": {
        "task_type": "psi",
        "keys": {
            "alice": ["uid"],
            "bob": ["uid"]
        },
        "input_paths": {
            "alice": "/app/data/alice.csv",
            "bob": "/app/data/bob.csv"
        },
        "output_paths": {
            "alice": "/app/data/alice_psi_out.csv",
            "bob": "/app/data/bob_psi_out.csv"
        },
        "receiver": "alice",
        "protocol": "KKRT_PSI_2PC",
        "sort": true
    }
}
```

**Bob节点发送的任务（如需在bob节点执行）：**
```python
task_params = {
    "task_id": "dag-bob-001",
    "subtask_id": "psi-node-bob", 
    "execution_id": "exec-bob-001-001",
    
    "sf_init_config": {
        "parties": {
            "alice": {
                "address": "192.168.1.50:7700",   # alice节点地址（远程）
                "listen_addr": "0.0.0.0:7700"
            },
            "bob": {
                "address": "127.0.0.1:7800",      # bob节点地址（本地）
                "listen_addr": "0.0.0.0:7800"
            }
        },
        "self_party": "bob",                       # 当前节点是bob
        "address": "127.0.0.1:7801"               # Ray集群地址
    },
    "spu_config": {
        "cluster_def": {
            "nodes": [
                {"party": "alice", "address": "192.168.1.50:12345"},
                {"party": "bob", "address": "127.0.0.1:12346"}
            ],
            "runtime_config": {
                "protocol": "SEMI2K",
                "field": "FM128"
            }
        }
    },
    "task_config": {
        "task_type": "psi",
        "keys": {
            "alice": ["uid"],
            "bob": ["uid"]
        },
        "input_paths": {
            "alice": "/app/data/alice.csv",
            "bob": "/app/data/bob.csv"
        },
        "output_paths": {
            "alice": "/app/data/alice_psi_out.csv",
            "bob": "/app/data/bob_psi_out.csv"
        },
        "receiver": "alice",
        "protocol": "KKRT_PSI_2PC",
        "sort": true
    }
}
```

**集群模式注意事项：**
- `self_party`必须设置为当前Worker容器所属的参与方
- `address`字段中，本地地址用`127.0.0.1`，远程地址用实际IP
- 确保各节点之间的端口可以互相访问（防火墙规则）
- 各节点的`listen_addr`通常设置为`0.0.0.0`以监听所有网卡

### 返回结果

#### 完整的Celery响应结构

通过Celery获取任务结果时，会返回完整的响应结构：

```python
{
    "status": "SUCCESS",                    # Celery任务状态（SUCCESS/FAILURE/PENDING等）
    "result": {
        "task_id": "dag-12345-abcde",
        "subtask_id": "node-67890-fghij",
        "execution_id": "exec-11111-klmno",
        "result": {                         # ← 这里是实际的SecretFlow任务结果
            "status": "success",            # 任务执行状态
            "result": {                     # ← 这里是任务的具体输出数据
                "intersection_count": 120,
                "output_paths": { ... },
                ...
            },
            "performance_metrics": { ... }, # 性能指标
            "task_metadata": { ... },       # 任务元数据
            "celery_metadata": { ... }      # Celery元数据
        },
        "completed_at": "2026-01-06T16:27:17.521966"
    },
    "traceback": null,
    "children": [],
    "date_done": "2026-01-06T16:27:17.522133",
    "task_id": "a67e039d-425c-4d27-a809-975ec3de6027"  # Celery任务ID
}
```

#### 如何提取任务结果

**Python代码示例：**

```python
# 方法1：通过Celery AsyncResult获取
from celery.result import AsyncResult

result = AsyncResult('a67e039d-425c-4d27-a809-975ec3de6027', app=app)
celery_response = result.get(timeout=300)

# 提取任务结果
task_result = celery_response["result"]["result"]  # 第一层result是Celery包装，第二层result是任务执行结果

# 访问具体数据
status = task_result["status"]                      # "success"
task_output = task_result["result"]                 # 任务的具体输出数据
intersection_count = task_output["intersection_count"]  # 120
output_paths = task_output["output_paths"]          # {...}
performance = task_result["performance_metrics"]    # 性能指标

# 方法2：简化提取
task_output = celery_response["result"]["result"]["result"]
print(f"交集数量: {task_output['intersection_count']}")
print(f"输出路径: {task_output['output_paths']}")
```

**结构层次说明：**
```
celery_response                          # Celery完整响应
└── ["result"]                           # 任务请求结果
    └── ["result"]                       # SecretFlow任务执行结果
        ├── ["status"]                   # 执行状态："success" 或 "failure"
        ├── ["result"]                   # ← 这里是任务的具体输出数据
        ├── ["performance_metrics"]      # 性能指标
        ├── ["task_metadata"]            # 任务元数据
        └── ["celery_metadata"]          # Celery元数据
```

#### 简化的任务输出数据（文档中的返回格式）

文档中列出的返回结果是指 `celery_response["result"]["result"]["result"]` 部分，即任务的具体输出数据：

```python
{
    "intersection_count": 120,          # 交集数量
    "output_paths": {                   # 输出文件路径
        "alice": "/app/data/alice_psi_out.csv",
        "bob": "/app/data/bob_psi_out.csv"
    },
    "psi_protocol": "KKRT_PSI_2PC",    # 使用的PSI协议
    "reports": [                        # 各方统计报告
        {
            "party": "alice",
            "original_count": 135,
            "intersection_count": 120
        },
        {
            "party": "bob",
            "original_count": 120,
            "intersection_count": -1    # -1表示该方不是receiver
        }
    ],
    "receiver": "alice",                # 接收方
    "parties": ["alice", "bob"]         # 参与方列表
}
```

#### 完整响应示例

```python
{
    "status": "SUCCESS",
    "result": {
        "task_id": "dag-12345-abcde",
        "subtask_id": "node-67890-fghij",
        "execution_id": "exec-11111-klmno",
        "result": {
            "status": "success",
            "result": {
                "intersection_count": 120,
                "output_paths": {
                    "alice": "/app/data/alice_psi_cli_out.csv",
                    "bob": "/app/data/bob_psi_cli_out.csv"
                },
                "psi_protocol": "KKRT_PSI_2PC",
                "reports": [
                    {"party": "alice", "original_count": 135, "intersection_count": 120},
                    {"party": "bob", "original_count": 120, "intersection_count": -1}
                ],
                "receiver": "alice",
                "parties": ["alice", "bob"]
            },
            "performance_metrics": {
                "total_execution_time": 13.4,
                "cluster_init_time": 5.4,
                "device_init_time": 0.11,
                "algorithm_exec_time": 7.88,
                "overhead_time": 0.01,
                "cluster_init_percentage": 40.3,
                "device_init_percentage": 0.8,
                "algorithm_exec_percentage": 58.8
            },
            "task_metadata": {
                "task_id": "dag-12345-abcde",
                "subtask_id": "node-67890-fghij",
                "execution_id": "exec-11111-klmno",
                "task_type": "psi",
                "started_at": "2026-01-06T16:27:02.146496",
                "completed_at": "2026-01-06T16:27:15.543394",
                "devices_used": ["alice", "bob", "spu"]
            },
            "celery_metadata": {
                "celery_task_id": "a67e039d-425c-4d27-a809-975ec3de6027",
                "celery_queue": "secretflow_queue",
                "celery_exchange": "",
                "retry_count": 0,
                "celery_execution_time": 15.38,
                "worker_hostname": "node1@211.87.232.108",
                "task_eta": null
            }
        },
        "completed_at": "2026-01-06T16:27:17.521966"
    },
    "task_id": "a67e039d-425c-4d27-a809-975ec3de6027"
}
```

---

## 2. SS-LR（逻辑回归）

### 任务类型
```python
task_type = "ss_lr"
```

### 任务配置
```python
{
    "task_type": "ss_lr",
    "train_data": {                    # 必需，训练数据路径
        "alice": "/app/data/alice_train.csv",
        "bob": "/app/data/bob_train.csv"
    },
    "features": ["x1", "x2", "x3"],   # 必需，特征列名列表
    "label": "y",                      # 必需，标签列名
    "label_party": "alice",            # 必需，标签所属方
    "model_output": {                  # 必需，模型输出路径（各方保存模型分片）
        "alice": "/app/data/alice_lr_model",
        "bob": "/app/data/bob_lr_model"
    },
    "params": {                        # 可选，训练参数
        "epochs": 10,                  # 训练轮数
        "learning_rate": 0.1,          # 学习率
        "batch_size": 128,             # 批次大小
        "reg_type": "logistic",        # 回归类型：logistic
        "penalty": "l2",               # 正则化：none, l1, l2
        "l2_norm": 0.1                 # L2正则化系数
    },
    "test_data": {                     # 可选，测试数据路径
        "alice": "/app/data/alice_test.csv",
        "bob": "/app/data/bob_test.csv"
    },
    "prediction_output": {             # 可选，预测结果输出路径
        "alice": "/app/data/alice_predictions.csv"
    },
    "prediction_receiver": "alice"     # 可选，预测结果接收方
}
```

### 返回结果
```python
{
    "status": "success",
    "result": {
        "model_saved": true,
        "model_paths": {
            "alice": "/app/data/alice_lr_model",
            "bob": "/app/data/bob_lr_model"
        },
        "training_metrics": {
            "epochs": 10,
            "final_loss": 0.234
        },
        "prediction_output": "/app/data/alice_predictions.csv"  # 如有测试数据
    }
}
```

---

## 3. SS-XGBoost

### 任务类型
```python
task_type = "ss_xgb"
```

### 任务配置
```python
{
    "task_type": "ss_xgb",
    "train_data": {                    # 必需，训练数据路径
        "alice": "/app/data/alice_train.csv",
        "bob": "/app/data/bob_train.csv"
    },
    "features": ["x1", "x2", "x3"],   # 必需，特征列名列表
    "label": "y",                      # 必需，标签列名
    "label_party": "alice",            # 必需，标签所属方
    "model_output": {                  # 必需，模型输出路径
        "alice": "/app/data/alice_xgb_model",
        "bob": "/app/data/bob_xgb_model"
    },
    "params": {                        # 可选，训练参数
        "num_boost_round": 10,         # 树的数量
        "max_depth": 5,                # 最大深度
        "learning_rate": 0.1,          # 学习率
        "objective": "logistic",       # 目标函数：logistic, linear
        "reg_lambda": 0.1,             # L2正则化
        "subsample": 1.0,              # 采样比例
        "colsample_by_tree": 1.0,      # 列采样比例
        "base_score": 0.5              # 初始预测分数
    },
    "test_data": {                     # 可选，测试数据
        "alice": "/app/data/alice_test.csv",
        "bob": "/app/data/bob_test.csv"
    },
    "prediction_output": {             # 可选，预测结果输出
        "alice": "/app/data/alice_xgb_predictions.csv"
    },
    "prediction_receiver": "alice"     # 可选，预测结果接收方
}
```

### 返回结果
```python
{
    "status": "success",
    "result": {
        "model_saved": true,
        "model_paths": {
            "alice": "/app/data/alice_xgb_model",
            "bob": "/app/data/bob_xgb_model"
        },
        "training_metrics": {
            "num_trees": 10
        },
        "prediction_output": "/app/data/alice_xgb_predictions.csv"
    }
}
```

---

## 4. 数据预处理任务

### 4.1 StandardScaler（标准化）

#### 任务类型
```python
task_type = "standard_scaler"
```

#### 任务配置
```python
{
    "task_type": "standard_scaler",
    "input_data": {                    # 必需，输入数据路径
        "alice": "/app/data/alice.csv",
        "bob": "/app/data/bob.csv"
    },
    "output_data": {                   # 必需，输出数据路径
        "alice": "/app/data/alice_scaled.csv",
        "bob": "/app/data/bob_scaled.csv"
    },
    "columns": ["x1", "x2", "x3"],    # 可选，需要标准化的列，默认全部数值列
    "with_mean": true,                 # 可选，是否减去均值（默认true）
    "with_std": true                   # 可选，是否除以标准差（默认true）
}
```

#### 返回结果
```python
{
    "status": "success",
    "result": {
        "output_paths": {
            "alice": "/app/data/alice_scaled.csv",
            "bob": "/app/data/bob_scaled.csv"
        },
        "columns_scaled": ["x1", "x2", "x3"]
    }
}
```

### 4.2 MinMaxScaler（归一化）

#### 任务类型
```python
task_type = "minmax_scaler"
```

#### 任务配置
```python
{
    "task_type": "minmax_scaler",
    "input_data": {
        "alice": "/app/data/alice.csv",
        "bob": "/app/data/bob.csv"
    },
    "output_data": {
        "alice": "/app/data/alice_minmax.csv",
        "bob": "/app/data/bob_minmax.csv"
    },
    "columns": ["x1", "x2"],          # 可选，需要归一化的列
    "feature_range": [0, 1]           # 可选，目标范围（默认[0,1]）
}
```

### 4.3 LabelEncoder（标签编码）

#### 任务类型
```python
task_type = "label_encoder"
```

#### 任务配置
```python
{
    "task_type": "label_encoder",
    "input_data": {
        "alice": "/app/data/alice.csv",
        "bob": "/app/data/bob.csv"
    },
    "output_data": {
        "alice": "/app/data/alice_encoded.csv",
        "bob": "/app/data/bob_encoded.csv"
    },
    "columns": ["category"]           # 必需，需要编码的分类列
}
```

### 4.4 OneHotEncoder（独热编码）

#### 任务类型
```python
task_type = "onehot_encoder"
```

#### 任务配置
```python
{
    "task_type": "onehot_encoder",
    "input_data": {
        "alice": "/app/data/alice.csv",
        "bob": "/app/data/bob.csv"
    },
    "output_data": {
        "alice": "/app/data/alice_onehot.csv",
        "bob": "/app/data/bob_onehot.csv"
    },
    "columns": ["category"],          # 必需，需要独热编码的列
    "drop": "first"                   # 可选，删除策略：first, none（默认none）
}
```

### 4.5 QuantileBinning（分位数分箱）

#### 任务类型
```python
task_type = "quantile_binning"
```

#### 任务配置
```python
{
    "task_type": "quantile_binning",
    "input_data": {
        "alice": "/app/data/alice.csv",
        "bob": "/app/data/bob.csv"
    },
    "output_data": {
        "alice": "/app/data/alice_binned.csv",
        "bob": "/app/data/bob_binned.csv"
    },
    "columns": ["x1", "x2"],          # 必需，需要分箱的列
    "bin_num": 10                     # 必需，分箱数量
}
```

### 4.6 EqualWidthBinning（等宽分箱）

#### 任务类型
```python
task_type = "equal_width_binning"
```

#### 任务配置
```python
{
    "task_type": "equal_width_binning",
    "input_data": {
        "alice": "/app/data/alice.csv",
        "bob": "/app/data/bob.csv"
    },
    "output_data": {
        "alice": "/app/data/alice_binned.csv",
        "bob": "/app/data/bob_binned.csv"
    },
    "columns": ["x1", "x2"],          # 必需，需要分箱的列
    "bin_num": 10                     # 必需，分箱数量
}
```

### 4.7 Fillna（缺失值填充）

#### 任务类型
```python
task_type = "fillna"
```

#### 任务配置
```python
{
    "task_type": "fillna",
    "input_data": {
        "alice": "/app/data/alice.csv",
        "bob": "/app/data/bob.csv"
    },
    "output_data": {
        "alice": "/app/data/alice_filled.csv",
        "bob": "/app/data/bob_filled.csv"
    },
    "columns": ["x1", "x2"],          # 可选，需要填充的列，默认所有列
    "method": "mean",                  # 必需，填充方法：mean, median, mode, constant
    "value": 0                         # 可选，当method='constant'时的填充值
}
```

---

## 5. 统计分析任务

### 5.1 TableStatistics（表统计）

#### 任务类型
```python
task_type = "table_statistics"
```

#### 任务配置
```python
{
    "task_type": "table_statistics",
    "input_data": {                    # 必需，输入数据路径
        "alice": "/app/data/alice.csv",
        "bob": "/app/data/bob.csv"
    },
    "columns": ["x1", "x2", "x3"],    # 可选，需要统计的列，默认所有数值列
    "output_report": "/app/data/table_stats_report.json"  # 必需，统计报告输出路径
}
```

#### 返回结果
```python
{
    "status": "success",
    "result": {
        "output_report": "/app/data/table_stats_report.json",
        "statistics": {
            "x1": {
                "count": 100,
                "mean": 50.5,
                "std": 29.01,
                "min": 1.0,
                "25%": 25.75,
                "50%": 50.5,
                "75%": 75.25,
                "max": 100.0
            },
            ...
        }
    }
}
```

### 5.2 PearsonCorrelation（皮尔逊相关系数）

#### 任务类型
```python
task_type = "pearson_correlation"
```

#### 任务配置
```python
{
    "task_type": "pearson_correlation",
    "input_data": {
        "alice": "/app/data/alice.csv",
        "bob": "/app/data/bob.csv"
    },
    "columns": ["x1", "x2", "x3"],    # 可选，需要计算相关系数的列
    "output_report": "/app/data/correlation_report.json"
}
```

#### 返回结果
```python
{
    "status": "success",
    "result": {
        "output_report": "/app/data/correlation_report.json",
        "correlation_matrix": {
            "x1": {"x1": 1.0, "x2": 0.85, "x3": 0.32},
            "x2": {"x1": 0.85, "x2": 1.0, "x3": 0.41},
            "x3": {"x1": 0.32, "x2": 0.41, "x3": 1.0}
        }
    }
}
```

### 5.3 VIF（方差膨胀因子）

#### 任务类型
```python
task_type = "vif"
```

#### 任务配置
```python
{
    "task_type": "vif",
    "input_data": {
        "alice": "/app/data/alice.csv",
        "bob": "/app/data/bob.csv"
    },
    "columns": ["x1", "x2", "x3"],    # 必需，需要计算VIF的特征列
    "output_report": "/app/data/vif_report.json"
}
```

#### 返回结果
```python
{
    "status": "success",
    "result": {
        "output_report": "/app/data/vif_report.json",
        "vif_values": {
            "x1": 2.5,
            "x2": 3.2,
            "x3": 1.8
        }
    }
}
```

---

## 6. 模型评估任务

### 6.1 BiClassificationEval（二分类评估）

#### 任务类型
```python
task_type = "biclassification_eval"
```

#### 任务配置
```python
{
    "task_type": "biclassification_eval",
    "prediction_data": {               # 必需，预测结果数据路径
        "alice": "/app/data/alice_predictions.csv"
    },
    "label_column": "y",               # 必需，真实标签列名
    "prediction_column": "pred_prob",  # 必需，预测概率列名
    "bucket_size": 10,                 # 可选，分桶数量（默认10）
    "output_report": "/app/data/biclass_eval_report.json"  # 必需，评估报告输出路径
}
```

#### 返回结果
```python
{
    "status": "success",
    "result": {
        "output_report": "/app/data/biclass_eval_report.json",
        "metrics": {
            "auc": 0.85,
            "ks": 0.42,
            "f1_score": 0.78,
            "precision": 0.82,
            "recall": 0.74,
            "accuracy": 0.80
        }
    }
}
```

### 6.2 RegressionEval（回归评估）

#### 任务类型
```python
task_type = "regression_eval"
```

#### 任务配置
```python
{
    "task_type": "regression_eval",
    "prediction_data": {
        "alice": "/app/data/alice_predictions.csv"
    },
    "label_column": "y",               # 必需，真实标签列名
    "prediction_column": "pred",       # 必需，预测值列名
    "output_report": "/app/data/regression_eval_report.json"
}
```

#### 返回结果
```python
{
    "status": "success",
    "result": {
        "output_report": "/app/data/regression_eval_report.json",
        "metrics": {
            "mse": 0.123,              # 均方误差
            "rmse": 0.351,             # 均方根误差
            "mae": 0.287,              # 平均绝对误差
            "r2_score": 0.89           # R²分数
        }
    }
}
```

---

## 7. 错误处理

### 错误响应格式
```python
{
    "status": "failure",
    "error": {
        "type": "ValueError",
        "message": "缺少必需字段: keys",
        "traceback": "..."
    }
}
```

### 常见错误码
- `ValueError`: 参数验证失败
- `FileNotFoundError`: 输入文件不存在
- `PermissionError`: 文件权限不足
- `RuntimeError`: 执行过程中出错

---

## 8. 任务状态监听

Worker容器在任务执行过程中会通过Redis发布任务状态事件，Web容器可以监听这些事件实时更新任务状态。

### 状态事件格式
```python
{
    "execution_id": "exec-uuid-from-db",       # 本次执行记录 ID
    "task_id": "task-uuid-from-db",            # 大任务/DAG ID
    "subtask_id": "subtask-uuid-from-db",      # 子任务/节点 ID
    "status": "RUNNING|SUCCESS|FAILURE|RETRY",
    "timestamp": "2026-01-07T00:00:00.000000Z",
    "data": {
        "task_id": "task-uuid-from-db",
        "subtask_id": "subtask-uuid-from-db", 
        "execution_id": "exec-uuid-from-db",
        "started_at": "timestamp",
        "result": {},
        "error": "error_message"
    },
    "worker_container": "secretflow-worker",
    "task_name": "tasks.secretflow.execute_task"
}
```

### Redis频道
- **发布订阅频道**: `task_status_events`
- **消息队列**: `task_status_queue`

---

## 9. 性能指标

任务执行完成后会返回性能指标：

```python
{
    "status": "success",
    "result": {...},
    "performance_metrics": {
        "total_execution_time": 13.4,      # 总耗时（秒）
        "cluster_init_time": 5.4,          # 集群初始化时间
        "device_init_time": 0.11,          # 设备初始化时间
        "algorithm_exec_time": 7.88,       # 算法执行时间
        "overhead_time": 0.01,             # 其他开销时间
        "cluster_init_percentage": 40.3,   # 集群初始化占比
        "device_init_percentage": 0.8,     # 设备初始化占比
        "algorithm_exec_percentage": 58.8  # 算法执行占比
    },
    "task_metadata": {
        "task_id": "psi-dag-12345",
        "subtask_id": "psi-node-67890",
        "execution_id": "psi-exec-11111",
        "task_type": "psi",
        "started_at": "2026-01-06T16:27:02.146496",
        "completed_at": "2026-01-06T16:27:15.543394",
        "devices_used": ["alice", "bob", "spu"]
    }
}
```

---

## 10. 最佳实践

### 10.1 文件路径规范
- 所有路径必须使用容器内绝对路径（如 `/app/data/xxx.csv`）
- 确保Worker容器有相应目录的读写权限
- 输出目录不存在时会自动创建

### 10.2 参与方命名
- 参与方名称必须一致（如都使用 `alice`, `bob`）
- 建议使用小写字母和下划线
- 避免使用特殊字符

### 10.3 数据格式
- 输入数据建议使用CSV格式
- CSV文件需包含列名（第一行）
- 数值列使用数字格式，避免包含非数字字符

### 10.4 任务超时
- 建议为任务设置合理的超时时间（如300秒）
- 大数据量任务可适当增加超时时间
- 超时后可通过Celery的重试机制重新执行

### 10.5 安全性建议
- 生产环境使用TLS/SSL加密Redis连接
- 限制文件路径访问范围
- 定期清理临时文件和日志

---

## 11. 版本信息

- **API版本**: v1.0.0
- **SecretFlow版本**: 1.x
- **最后更新**: 2026-01-07

---

## 12. 联系方式

如有问题或建议，请通过以下方式联系：
- 项目仓库: `/disc/home/beng003/work/secretflow-worker`
- 文档路径: `docs/worker-api/worker-api.md`
