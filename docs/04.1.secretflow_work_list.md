# SecretFlow Worker端详细开发规划

## 项目概述

基于简化后的设计架构，开发SecretFlow Worker容器端的任务执行系统，实现标准化的多方安全计算任务处理能力。项目采用同步执行模式，集成现有Redis状态监听系统，支持PSI、机器学习等多种算法类型。

## 开发环境与依赖

### 技术栈
- **SecretFlow Framework**: >=1.0.0
- **Python**: >=3.8
- **Redis**: 状态通信
- **Celery**: 任务队列
- **Ray**: 分布式计算后端

### 项目结构
```
src/
├── secretflow/                    # SecretFlow核心模块
│   ├── __init__.py
│   ├── task_executor.py          # 主要任务执行器
│   ├── cluster_initializer.py    # 集群初始化管理器
│   ├── device_manager.py         # 设备管理器
│   ├── data_loader.py            # 数据加载器
│   ├── algorithms/               # 算法实现
│   │   ├── __init__.py
│   │   ├── psi_executor.py       # PSI算法
│   │   ├── lr_executor.py        # 逻辑回归
│   │   └── base_executor.py      # 基础执行器
├── celery_tasks.py               # Celery任务集成
├── config/
│    └── task_registry.py         # 任务注册表
├── utils/                    # 工具模块
│    ├── __init__.py
│    ├── validator.py          # 参数验证
     ├── status_notifier.py    # 状态通知(集成现有)
     └── exceptions.py         # 异常定义
```

---

## Phase 1: 基础架构搭建 (预计4天)

### 任务1.1: 核心模块框架搭建
**目标**: 建立项目基础架构和核心接口

#### 子任务:
- [x] **1.1.1** 创建SecretFlow模块目录结构
- [x] **1.1.2** 实现基础任务执行器接口 (`BaseTaskExecutor`)
- [x] **1.1.3** 设计设备管理器接口 (`DeviceManager`)
- [x] **1.1.4** 创建参数验证模块 (`validator.py`)
- [x] **1.1.5** 定义项目异常类体系 (`exceptions.py`)

**预期产出**:
```python
# src/secretflow/algorithms/base_executor.py
class BaseTaskExecutor:
    def __init__(self, task_request_id: str, task_config: dict):
        pass
    
    def validate_params(self) -> bool:
        pass
    
    def execute(self) -> dict:
        pass
```

**验收标准**:
- [x] 所有模块可正常导入
- [x] 基础接口定义完整
- [x] 通过基础单元测试

---

### 任务1.2: SecretFlow集群初始化 *(简化版)*
**目标**: 实现SecretFlow集群的简单初始化和生命周期管理

#### 子任务:
- [x] **1.2.1** 实现SecretFlow集群初始化管理器
- [x] **1.2.2** 实现集群关闭和资源清理
- [x] **1.2.3** 添加基础错误处理和日志记录

**预期产出**:
```python
# src/secretflow/cluster_initializer.py
class SecretFlowClusterInitializer:
    def __init__(self):
        self._cluster_initialized = False
    
    def initialize_cluster(self, sf_init_config: dict) -> bool:
        """使用sf.init(**sf_init_config)初始化集群"""
        pass
    
    def shutdown_cluster(self):
        """使用sf.shutdown()关闭集群"""
        pass
    
    def is_cluster_ready(self) -> bool:
        """检查集群状态"""
        pass
```

**验收标准**:
- [x] 集群可成功初始化和关闭
- [x] 参数验证交给SecretFlow框架处理
- [x] 基础错误处理和日志记录

---

### 任务1.3: 设备管理系统 *(已完成)*
**目标**: 实现SecretFlow计算设备的简化管理

#### 子任务:
- [x] **1.3.1** 实现SPU设备初始化逻辑 *(使用SPU(**config))*
- [x] **1.3.2** 实现HEU设备初始化逻辑 *(使用HEU(**config))*
- [x] **1.3.3** 实现设备生命周期管理(创建/销毁)
- [x] **1.3.4** 添加错误处理和日志记录

**预期产出**:
```python
# src/secretflow/device_manager.py
class DeviceManager:
    def initialize_devices(self, spu_config: dict | None = None, heu_config: dict | None = None) -> dict:
        """按需初始化设备，有配置就初始化"""
        pass
    
    def create_spu_device(self, config: dict) -> SPU:
        """直接使用SPU(**config)创建"""
        pass
    
    def create_heu_device(self, config: dict) -> HEU:
        """直接使用HEU(**config)创建"""
        pass
    
    def cleanup_devices(self):
        """调用device.shutdown()清理资源"""
        pass
```

**验收标准**:
- [x] SPU/HEU设备可正常创建和销毁
- [x] 参数验证交给SecretFlow框架处理
- [x] 简化的按需初始化逻辑
- [x] 基础错误处理和时间记录

---

### 任务1.4: 状态通知集成 *(简化版)*
**目标**: 集成现有Redis状态监听系统

#### 子任务:
- [x] **1.4.1** 实现简单的状态通知函数
- [x] **1.4.2** 集成现有_publish_task_event接口

**预期产出**:
```python
# src/utils/status_notifier.py (已存在，简化扩展)
def _publish_status(task_request_id: str, status: str, data: dict = None):
    """简单的状态上报，失败不影响主任务"""
    try:
        from utils.status_notifier import _publish_task_event
        _publish_task_event(task_request_id, status, data or {}, "task.secretflow")
    except Exception:
        pass  # 静默失败，不影响主任务
```

**验收标准**:
- [x] 简单可靠的状态上报
- [x] 失败不影响主任务执行

---

## Phase 2: 数据处理系统 (预计3天)

### 任务2.1: 数据加载器开发 *(简化版)*
**目标**: 实现基础的数据加载功能

#### 子任务:
- [x] **2.1.1** 实现基础CSV/JSON数据加载
- [x] **2.1.2** 创建SecretFlow联邦数据对象

**预期产出**:
```python
# src/secretflow/data_loader.py
class DataLoader:
    def load_party_data(self, party_name: str, data_path: str) -> pd.DataFrame:
        """使用pandas直接加载数据"""
        return pd.read_csv(data_path)  # 简单实现
    
    def create_secretflow_data(self, data_config: dict) -> dict:
        """使用SecretFlow API创建联邦数据"""
        pass
```

**验收标准**:
- [x] 基础数据加载功能可用
- [x] 与SecretFlow数据API集成

---

### ~~任务2.2: 输出管理系统~~ *(删除)*
*简化理由: 结果输出由SecretFlow算法自身处理，无需额外封装*

---

## Phase 3: 算法执行器实现 (预计5天)

### 任务3.1: PSI算法执行器 *(简化版)*
**目标**: 实现基础PSI算法调用

#### 子任务:
- [ ] **3.1.1** 实现基础PSI执行逻辑
- [ ] **3.1.2** 调用SecretFlow PSI API

**预期产出**:
```python
# src/secretflow/algorithms/psi_executor.py
class PSIExecutor(BaseTaskExecutor):
    def execute(self) -> dict:
        """直接调用SecretFlow PSI API"""
        import secretflow as sf
        # 使用sf.psi相关API执行PSI计算
        pass
```

**验收标准**:
- [ ] 基础PSI功能可用
- [ ] 参数验证交给SecretFlow处理

---

### 任务3.2: 机器学习算法执行器 *(简化版)*
**目标**: 实现基础机器学习算法调用

#### 子任务:
- [ ] **3.2.1** 实现逻辑回归执行器

**预期产出**:
```python
# src/secretflow/algorithms/lr_executor.py
class LogisticRegressionExecutor(BaseTaskExecutor):
    def execute(self) -> dict:
        """直接调用SecretFlow ML API"""
        import secretflow as sf
        # 使用sf.ml相关API执行机器学习任务
        pass
```

**验收标准**:
- [ ] 基础逻辑回归功能可用

---

### 任务3.3: 算法注册系统
**目标**: 实现动态算法注册和路由机制

#### 子任务:
- [ ] **3.3.1** 设计算法注册表结构
- [ ] **3.3.2** 实现动态算法发现机制
- [ ] **3.3.3** 添加算法版本管理
- [ ] **3.3.4** 创建算法执行工厂模式
- [ ] **3.3.5** 实现算法兼容性检查

**预期产出**:
```python
# src/config/task_registry.py
ALGORITHM_REGISTRY = {
    "psi": PSIExecutor,
    "lr": LogisticRegressionExecutor,
    # 支持动态扩展
}

class AlgorithmFactory:
    def create_executor(self, task_type: str, task_request_id: str, task_config: dict):
        pass
```

**验收标准**:
- [ ] 支持热插拔算法注册
- [ ] 算法版本向后兼容
- [ ] 执行器创建性能优化
- [ ] 完整的错误处理机制

---

## Phase 4: 主执行器集成 (预计3天)

### 任务4.1: 主执行器实现
**目标**: 实现统一的SecretFlow任务执行入口

#### 子任务:
- [ ] **4.1.1** 实现execute_secretflow_task主函数
- [ ] **4.1.2** 集成所有子模块(验证/设备/数据/算法)
- [ ] **4.1.3** 实现完整的执行流程控制
- [ ] **4.1.4** 添加执行时间和性能监控
- [ ] **4.1.5** 实现资源自动清理机制

**预期产出**:
```python
# src/secretflow/task_executor.py
def execute_secretflow_task(
    task_request_id: str,
    sf_init_config: dict,
    spu_config: dict,
    heu_config: dict,
    task_config: dict
) -> dict:
    """SecretFlow任务执行主函数"""
    # 1. 初始化SecretFlow集群
    cluster_initializer = SecretFlowClusterInitializer()
    cluster_initializer.initialize_cluster(sf_init_config)
    
    try:
        # 2. 初始化计算设备
        device_manager = DeviceManager()
        devices = device_manager.initialize_devices(spu_config, heu_config)
        
        # 3. 执行具体算法任务
        executor = AlgorithmFactory.create_executor(
            task_config['task_type'], task_request_id, task_config
        )
        results = executor.execute()
        
        return results
    finally:
        # 4. 清理资源和关闭集群
        cluster_initializer.shutdown_cluster()
```

**验收标准**:
- [ ] 函数签名完全符合设计文档
- [ ] SecretFlow集群正确初始化和关闭
- [ ] 支持所有设计的算法类型
- [ ] 资源清理机制完整可靠
- [ ] 状态上报完整准确
- [ ] 异常处理健壮可靠

---

### 任务4.2: Celery任务集成
**目标**: 将SecretFlow执行器集成到Celery任务队列

#### 子任务:
- [ ] **4.2.1** 创建Celery任务包装器
- [ ] **4.2.2** 实现任务参数序列化/反序列化
- [ ] **4.2.3** 添加任务超时和重试机制
- [ ] **4.2.4** 集成现有Celery配置
- [ ] **4.2.5** 实现任务执行监控

**预期产出**:
```python
# celery_tasks.py
@celery_app.task(bind=True, name="tasks.secretflow.execute_task")
def execute_secretflow_celery_task(self, task_request_id: str, task_params: dict):
    """SecretFlow任务的Celery包装器"""
    pass
```

**验收标准**:
- [ ] 与现有Celery系统无缝集成
- [ ] 任务执行状态正确追踪
- [ ] 支持长时间运行任务
- [ ] 任务失败自动重试机制

---

## Phase 5: 测试与优化 (预计4天)

### 任务5.1: 单元测试开发
**目标**: 实现完整的单元测试覆盖

#### 子任务:
- [ ] **5.1.1** 参数验证模块测试(>90%覆盖率)
- [ ] **5.1.2** 集群初始化器测试(模拟环境)
- [ ] **5.1.3** 设备管理器测试(模拟环境)
- [ ] **5.1.4** 数据加载器测试(多种数据格式)
- [ ] **5.1.5** 算法执行器测试(小数据集)
- [ ] **5.1.6** 主执行器集成测试

**预期产出**:
```
tests/
├── test_validator.py
├── test_cluster_initializer.py
├── test_device_manager.py
├── test_data_loader.py
├── test_algorithms/
│   ├── test_psi_executor.py
│   └── test_lr_executor.py
└── test_task_executor.py
```

**验收标准**:
- [ ] 单元测试覆盖率 >85%
- [ ] 所有测试用例通过
- [ ] 测试执行时间 <5分钟
- [ ] 边界条件充分测试

---

### 任务5.2: 集成测试验证
**目标**: 验证端到端任务执行流程

#### 子任务:
- [ ] **5.2.1** PSI任务完整流程测试
- [ ] **5.2.2** 机器学习任务完整流程测试
- [ ] **5.2.3** 多参与方协作测试
- [ ] **5.2.4** 异常场景恢复测试
- [ ] **5.2.5** 性能基准测试

**预期产出**:
```
tests/integration/
├── test_psi_end_to_end.py
├── test_ml_end_to_end.py
├── test_multiparty_collaboration.py
└── test_performance_benchmarks.py
```

**验收标准**:
- [ ] 端到端测试100%通过
- [ ] 支持2-5方计算验证
- [ ] 性能指标符合预期
- [ ] 状态监听系统正确工作

---

### 任务5.3: 性能优化与调优
**目标**: 优化系统性能和资源使用

#### 子任务:
- [ ] **5.3.1** 设备初始化性能优化
- [ ] **5.3.2** 数据加载内存优化
- [ ] **5.3.3** 算法执行并发优化
- [ ] **5.3.4** 状态上报批量优化
- [ ] **5.3.5** 系统资源监控集成

**预期产出**:
- 设备初始化时间: <10秒(2方场景)
- 数据加载性能: >50MB/s
- PSI计算性能: 10万条记录<5分钟
- 内存使用优化: <预算值80%

**验收标准**:
- [ ] 所有性能指标达标
- [ ] 资源泄漏零容忍
- [ ] 并发安全验证通过
- [ ] 长时间运行稳定性测试

---

## Phase 6: 部署与文档 (预计2天)

### 任务6.1: Docker集成和部署
**目标**: 完善容器化部署方案

#### 子任务:
- [ ] **6.1.1** 更新Dockerfile添加SecretFlow依赖
- [ ] **6.1.2** 配置Docker Compose服务编排
- [ ] **6.1.3** 创建环境变量配置模板
- [ ] **6.1.4** 实现健康检查机制
- [ ] **6.1.5** 添加容器监控和日志收集

**预期产出**:
```yaml
# docker/docker-compose.yml (更新)
services:
  secretflow-worker:
    environment:
      - ENABLE_SECRETFLOW_TASKS=true
      - SECRETFLOW_LOG_LEVEL=INFO
      - REDIS_URL=redis://redis:6379/0
```

**验收标准**:
- [ ] 容器启动时间 <30秒
- [ ] 健康检查机制正常
- [ ] 日志输出格式标准化
- [ ] 与现有容器架构兼容

---

### 任务6.2: 技术文档完善
**目标**: 提供完整的技术文档

#### 子任务:
- [ ] **6.2.1** API使用说明文档
- [ ] **6.2.2** 算法配置参考手册
- [ ] **6.2.3** 故障排除指南
- [ ] **6.2.4** 性能调优建议
- [ ] **6.2.5** 开发者贡献指南

**预期产出**:
```
docs/
├── api_reference.md
├── algorithm_guide.md
├── troubleshooting.md
├── performance_tuning.md
└── developer_guide.md
```

**验收标准**:
- [ ] 文档覆盖所有核心功能
- [ ] 代码示例可直接运行
- [ ] 常见问题解决方案完整
- [ ] 文档格式统一规范

---

## 项目风险评估与应对

### 高风险项目
1. **SecretFlow版本兼容性风险**
   - **应对**: 固定依赖版本，建立兼容性测试矩阵
   - **负责人**: 架构组
   - **检查点**: Phase 1完成时

2. **多方通信稳定性风险**
   - **应对**: 实现重试机制，添加网络质量监控
   - **负责人**: 网络组
   - **检查点**: Phase 3测试时

3. **性能瓶颈风险**
   - **应对**: 持续性能监控，分阶段优化
   - **负责人**: 性能组
   - **检查点**: 每个Phase结束时

### 中风险项目
1. **算法精度验证**
   - **应对**: 建立标准测试数据集，对比验证
2. **资源消耗控制**
   - **应对**: 实现资源限制，监控告警

## 项目成功标准

### 功能完整性指标
- [ ] 支持PSI和至少2种ML算法
- [ ] 状态监听系统100%可用
- [ ] 参数验证准确率100%
- [ ] 异常处理覆盖率>95%

### 性能指标
- [ ] 2方PSI(10万记录): <5分钟
- [ ] 设备初始化时间: <10秒
- [ ] 内存使用: <分配值80%
- [ ] 任务成功率: >99%

### 可维护性指标
- [ ] 代码测试覆盖率: >85%
- [ ] 技术文档完整性: 100%
- [ ] 代码规范检查: 100%通过
- [ ] 部署自动化: 一键部署

---

## 开发时间线总结

| 阶段 | 预计时间 | 关键里程碑 | 交付物 |
|------|----------|------------|--------|
| Phase 1 | 4天 | 基础架构完成 | 核心模块框架 |
| Phase 2 | 3天 | 数据处理就绪 | 数据加载器 |
| Phase 3 | 5天 | 算法执行器完成 | PSI+ML算法 |
| Phase 4 | 3天 | 系统集成完成 | 主执行器 |
| Phase 5 | 4天 | 测试验证通过 | 测试报告 |
| Phase 6 | 2天 | 生产就绪 | 部署文档 |
| **总计** | **21天** | **生产发布** | **完整系统** |

**团队建议**: 2-3名开发人员并行开发，1名测试工程师
**发布目标**: 3周内完成MVP版本，4周内达到生产就绪状态

---

*本开发规划基于简化后的参数设计和同步执行架构，确保与现有Redis状态监听系统的完美集成。所有任务完成后请在对应的复选框中标记X。*